<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S.I.M - Simple Inventory Management</title>

    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2563EB", // Blue 600
              secondary: "#475569", // Slate 600
              success: "#16A34A", // Green 600
              danger: "#DC2626", // Red 600
              warning: "#CA8A04", // Yellow 600
            },
          },
        },
      };
    </script>
    <!-- FONT AWESOME -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- SHEETJS (Cho tính năng Export Excel - US20) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
      /* CSS Tùy chỉnh */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .sidebar-item.active {
        background-color: rgba(37, 99, 235, 0.1);
        color: #2563eb;
        border-right: 3px solid #2563eb;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Toast Animation */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .toast-enter {
        animation: slideIn 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 h-screen flex overflow-hidden">
    <!-- SIDEBAR -->
    <aside class="w-64 bg-white shadow-md flex flex-col z-10 hidden md:flex">
      <div class="p-6 border-b flex items-center gap-2">
        <i class="fas fa-boxes text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-gray-800">S.I.M Inventory</h1>
      </div>

      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-1">
          <li>
            <a
              href="#"
              onclick="App.navigate('dashboard')"
              id="nav-dashboard"
              class="sidebar-item flex items-center gap-3 px-6 py-3 hover:bg-gray-50 text-gray-600 transition-colors active"
            >
              <i class="fas fa-chart-line w-5"></i>
              <span>Tổng quan (US18)</span>
            </a>
          </li>
          <li>
            <a
              href="#"
              onclick="App.navigate('products')"
              id="nav-products"
              class="sidebar-item flex items-center gap-3 px-6 py-3 hover:bg-gray-50 text-gray-600 transition-colors"
            >
              <i class="fas fa-box w-5"></i> <span>Sản phẩm (US01-04)</span>
            </a>
          </li>
          <li>
            <a
              href="#"
              onclick="App.navigate('transactions')"
              id="nav-transactions"
              class="sidebar-item flex items-center gap-3 px-6 py-3 hover:bg-gray-50 text-gray-600 transition-colors"
            >
              <i class="fas fa-exchange-alt w-5"></i>
              <span>Nhập/Xuất (US05-06)</span>
            </a>
          </li>
          <li>
            <a
              href="#"
              onclick="App.navigate('stocktake')"
              id="nav-stocktake"
              class="sidebar-item flex items-center gap-3 px-6 py-3 hover:bg-gray-50 text-gray-600 transition-colors"
            >
              <i class="fas fa-clipboard-check w-5"></i>
              <span>Kiểm kê kho (US10)</span>
            </a>
          </li>
        </ul>
      </nav>

      <div class="p-4 border-t text-xs text-gray-500 text-center">
        &copy; 2026 S.I.M System v1.0
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <!-- Header Mobile & User Info -->
      <header
        class="bg-white shadow-sm p-4 flex justify-between items-center md:justify-end"
      >
        <button
          class="md:hidden text-gray-600"
          onclick="document.querySelector('aside').classList.toggle('hidden')"
        >
          <i class="fas fa-bars text-xl"></i>
        </button>
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-gray-600">Admin User</span>
          <div
            class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold"
          >
            A
          </div>
        </div>
      </header>

      <!-- Content Views -->
      <div
        id="main-container"
        class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-100 custom-scrollbar relative"
      >
        <!-- VIEW: DASHBOARD (US18) -->
        <div id="view-dashboard" class="space-y-6">
          <div class="flex justify-between items-end">
            <h2 class="text-2xl font-bold text-gray-800">Tổng quan kho hàng</h2>
            <button
              onclick="InventoryService.exportToExcel()"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm transition-colors"
            >
              <i class="fas fa-file-excel mr-2"></i> Xuất Báo Cáo (US20)
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Total Value -->
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-primary"
            >
              <div class="text-gray-500 text-sm font-medium">
                Tổng giá trị tồn kho
              </div>
              <div
                class="text-2xl font-bold text-gray-800 mt-2"
                id="dash-total-value"
              >
                0 VND
              </div>
              <div class="text-xs text-green-500 mt-1">
                <i class="fas fa-arrow-up"></i> Cập nhật realtime
              </div>
            </div>
            <!-- Total Items -->
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-indigo-500"
            >
              <div class="text-gray-500 text-sm font-medium">
                Tổng số lượng sản phẩm
              </div>
              <div
                class="text-2xl font-bold text-gray-800 mt-2"
                id="dash-total-items"
              >
                0
              </div>
              <div class="text-xs text-gray-400 mt-1">Đang hoạt động</div>
            </div>
            <!-- Low Stock Alert (US09 - Level 3 but good for UI) -->
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-warning"
            >
              <div class="text-gray-500 text-sm font-medium">
                Cảnh báo sắp hết hàng
              </div>
              <div
                class="text-2xl font-bold text-gray-800 mt-2"
                id="dash-low-stock"
              >
                0
              </div>
              <div class="text-xs text-red-500 mt-1">Cần nhập thêm</div>
            </div>
          </div>

          <!-- Recent History (US19 Preview) -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="font-bold text-lg mb-4 text-gray-700">
              Lịch sử giao dịch gần đây
            </h3>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="text-xs text-gray-500 border-b uppercase">
                    <th class="p-3">Mã GD</th>
                    <th class="p-3">Loại</th>
                    <th class="p-3">Sản phẩm</th>
                    <th class="p-3 text-right">Số lượng</th>
                    <th class="p-3 text-right">Thời gian</th>
                  </tr>
                </thead>
                <tbody id="dash-history-list" class="text-sm">
                  <!-- JS render -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PRODUCTS (US01, US02, US04) -->
        <div id="view-products" class="hidden space-y-6">
          <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
          >
            <h2 class="text-2xl font-bold text-gray-800">Quản lý sản phẩm</h2>
            <button
              onclick="ProductController.openModal()"
              class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition-colors flex items-center gap-2"
            >
              <i class="fas fa-plus"></i> Thêm mới (US01)
            </button>
          </div>

          <!-- Product List -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="p-4 border-b flex gap-4">
              <input
                type="text"
                id="product-search"
                placeholder="Tìm kiếm tên, SKU... (US03)"
                class="w-full md:w-1/3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead
                  class="bg-gray-50 text-gray-600 text-xs uppercase font-semibold"
                >
                  <tr>
                    <th class="p-4">SKU</th>
                    <th class="p-4">Tên sản phẩm</th>
                    <th class="p-4">Danh mục</th>
                    <th class="p-4 text-right">Giá vốn</th>
                    <th class="p-4 text-right">Giá bán</th>
                    <th class="p-4 text-center">Tồn kho</th>
                    <th class="p-4 text-center">Hành động</th>
                  </tr>
                </thead>
                <tbody
                  id="product-list-body"
                  class="divide-y divide-gray-100 text-sm"
                >
                  <!-- Render by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: TRANSACTIONS (US05, US06, US15) -->
        <div id="view-transactions" class="hidden space-y-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Nhập / Xuất Kho</h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Transaction Form -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="flex gap-2 mb-6 bg-gray-100 p-1 rounded-lg">
                <button
                  onclick="TransactionController.setMode('IN')"
                  id="btn-mode-in"
                  class="flex-1 py-2 rounded-md font-medium text-sm transition-all bg-white shadow text-primary"
                >
                  Nhập hàng (US05)
                </button>
                <button
                  onclick="TransactionController.setMode('OUT')"
                  id="btn-mode-out"
                  class="flex-1 py-2 rounded-md font-medium text-sm transition-all text-gray-500"
                >
                  Xuất bán (US06)
                </button>
                <button
                  onclick="TransactionController.setMode('RETURN')"
                  id="btn-mode-return"
                  class="flex-1 py-2 rounded-md font-medium text-sm transition-all text-gray-500"
                >
                  Khách trả (US15)
                </button>
              </div>

              <form
                id="transaction-form"
                onsubmit="TransactionController.submit(event)"
              >
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Chọn sản phẩm</label
                    >
                    <select
                      id="trans-product-id"
                      class="w-full p-2 border rounded focus:ring-2 focus:ring-primary outline-none"
                      required
                      onchange="TransactionController.onProductSelect()"
                    >
                      <option value="">-- Chọn sản phẩm --</option>
                    </select>
                    <div
                      id="trans-stock-hint"
                      class="text-xs text-gray-500 mt-1"
                    >
                      Tồn hiện tại: -
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Số lượng</label
                      >
                      <input
                        type="number"
                        id="trans-quantity"
                        min="1"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-primary outline-none"
                        required
                      />
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                        >Đơn giá (VND)</label
                      >
                      <input
                        type="number"
                        id="trans-price"
                        min="0"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-primary outline-none"
                        required
                      />
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Ghi chú (Lý do)</label
                    >
                    <input
                      type="text"
                      id="trans-note"
                      class="w-full p-2 border rounded focus:ring-2 focus:ring-primary outline-none"
                      placeholder="VD: Nhập hàng NCC A, Bán lẻ..."
                    />
                  </div>

                  <button
                    type="submit"
                    class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition-colors mt-2"
                    id="trans-submit-btn"
                  >
                    <i class="fas fa-check mr-2"></i> Xác nhận Nhập Kho
                  </button>
                </div>
              </form>
            </div>

            <!-- History / Product Card (US19) -->
            <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col h-full">
              <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">
                Thẻ kho (Lịch sử SP)
              </h3>
              <div class="flex-1 overflow-y-auto custom-scrollbar relative">
                <div
                  id="stock-card-empty"
                  class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm"
                >
                  Chọn một sản phẩm để xem lịch sử
                </div>
                <ul id="stock-card-list" class="space-y-3 hidden">
                  <!-- JS Render -->
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: STOCKTAKE (US10) -->
        <div id="view-stocktake" class="hidden space-y-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">
            Kiểm kê kho hàng (Stocktake)
          </h2>
          <p class="text-sm text-gray-500 mb-4">
            Điều chỉnh số lượng thực tế trong kho so với hệ thống.
          </p>

          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <table class="w-full text-left">
              <thead
                class="bg-gray-50 text-gray-600 text-xs uppercase font-semibold"
              >
                <tr>
                  <th class="p-4">Sản phẩm</th>
                  <th class="p-4 text-center">Tồn hệ thống</th>
                  <th class="p-4 text-center w-40">Thực tế</th>
                  <th class="p-4 text-center w-24">Lệch</th>
                  <th class="p-4 text-right">Xác nhận</th>
                </tr>
              </thead>
              <tbody
                id="stocktake-list-body"
                class="divide-y divide-gray-100 text-sm"
              >
                <!-- JS Render -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- MODAL: PRODUCT (ADD/EDIT) -->
    <div
      id="modal-product"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg shadow-lg w-full max-w-md overflow-hidden transform transition-all"
      >
        <div
          class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"
        >
          <h3 class="font-bold text-lg text-gray-800" id="modal-product-title">
            Thêm sản phẩm mới
          </h3>
          <button
            onclick="ProductController.closeModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form
          id="product-form"
          onsubmit="ProductController.save(event)"
          class="p-6 space-y-4"
        >
          <input type="hidden" id="prod-id" />
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase"
                >Mã SKU</label
              >
              <input
                type="text"
                id="prod-sku"
                class="w-full border p-2 rounded focus:ring-primary outline-none"
                required
              />
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase"
                >Đơn vị</label
              >
              <input
                type="text"
                id="prod-unit"
                class="w-full border p-2 rounded focus:ring-primary outline-none"
                placeholder="Cái, Hộp..."
                required
              />
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 uppercase"
              >Tên sản phẩm</label
            >
            <input
              type="text"
              id="prod-name"
              class="w-full border p-2 rounded focus:ring-primary outline-none"
              required
            />
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 uppercase"
              >Danh mục (US03)</label
            >
            <select
              id="prod-category"
              class="w-full border p-2 rounded focus:ring-primary outline-none"
            >
              <option value="Electronics">Điện tử</option>
              <option value="Food">Thực phẩm</option>
              <option value="Clothing">Thời trang</option>
              <option value="General">Khác</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase"
                >Giá vốn</label
              >
              <input
                type="number"
                id="prod-cost"
                class="w-full border p-2 rounded focus:ring-primary outline-none"
                required
              />
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase"
                >Giá bán</label
              >
              <input
                type="number"
                id="prod-price"
                class="w-full border p-2 rounded focus:ring-primary outline-none"
                required
              />
            </div>
          </div>
          <div class="pt-4 flex justify-end gap-2">
            <button
              type="button"
              onclick="ProductController.closeModal()"
              class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
            >
              Hủy
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-primary text-white rounded hover:bg-blue-700 shadow"
            >
              Lưu
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div
      id="toast-container"
      class="fixed top-5 right-5 z-50 flex flex-col gap-2"
    ></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      /**
       * =========================================================================
       * DATA LAYER (MOCK DB)
       * Dữ liệu giả lập chạy trên RAM trình duyệt
       * =========================================================================
       */
      const MockDB = {
        products: [
          {
            id: "101",
            sku: "IP13",
            name: "iPhone 13 128GB",
            category: "Electronics",
            cost: 15000000,
            price: 18000000,
            unit: "Cái",
            quantity: 10,
            isActive: true,
          },
          {
            id: "102",
            sku: "SS22",
            name: "Samsung S22 Ultra",
            category: "Electronics",
            cost: 20000000,
            price: 25000000,
            unit: "Cái",
            quantity: 5,
            isActive: true,
          },
          {
            id: "103",
            sku: "MILK01",
            name: "Sữa tươi TH True Milk",
            category: "Food",
            cost: 25000,
            price: 32000,
            unit: "Hộp",
            quantity: 100,
            isActive: true,
          },
        ],
        transactions: [
          {
            id: "T001",
            type: "IN",
            productId: "101",
            quantity: 10,
            price: 15000000,
            date: "2025-12-01 09:00",
            note: "Nhập hàng ban đầu",
          },
          {
            id: "T002",
            type: "IN",
            productId: "102",
            quantity: 5,
            price: 20000000,
            date: "2025-12-02 10:00",
            note: "Nhập hàng NCC A",
          },
          {
            id: "T003",
            type: "IN",
            productId: "103",
            quantity: 100,
            price: 25000,
            date: "2025-12-03 14:00",
            note: "Nhập siêu thị",
          },
        ],
      };

      /**
       * =========================================================================
       * UTILS (Các hàm tiện ích)
       * =========================================================================
       */
      const Utils = {
        formatCurrency: (amount) =>
          new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(amount),
        formatDate: (dateStr) => {
          const date = dateStr ? new Date(dateStr) : new Date();
          return date.toLocaleString("vi-VN");
        },
        showToast: (message, type = "success") => {
          const container = document.getElementById("toast-container");
          const div = document.createElement("div");
          const bgColor =
            type === "success"
              ? "bg-green-500"
              : type === "error"
              ? "bg-red-500"
              : "bg-blue-500";
          div.className = `${bgColor} text-white px-4 py-3 rounded shadow-lg flex items-center gap-2 toast-enter`;
          div.innerHTML = `<i class="fas ${
            type === "success" ? "fa-check-circle" : "fa-info-circle"
          }"></i> <span>${message}</span>`;
          container.appendChild(div);
          setTimeout(() => div.remove(), 3000);
        },
        generateId: () => Math.random().toString(36).substr(2, 6).toUpperCase(),
      };

      /**
       * =========================================================================
       * SERVICE LAYER
       * Xử lý logic nghiệp vụ, tính toán kho
       * =========================================================================
       */
      const InventoryService = {
        // Lấy danh sách sản phẩm (US03 - support filter)
        getProducts: (filter = "") => {
          let data = MockDB.products.filter((p) => p.isActive);
          if (filter) {
            const lower = filter.toLowerCase();
            data = data.filter(
              (p) =>
                p.name.toLowerCase().includes(lower) ||
                p.sku.toLowerCase().includes(lower)
            );
          }
          return data;
        },

        getProductById: (id) => MockDB.products.find((p) => p.id === id),

        // US01: Thêm sản phẩm
        addProduct: (productData) => {
          const newProduct = {
            ...productData,
            id: Utils.generateId(),
            quantity: 0,
            isActive: true,
          };
          MockDB.products.push(newProduct);
          return newProduct;
        },

        // US02: Sửa sản phẩm
        updateProduct: (id, data) => {
          const index = MockDB.products.findIndex((p) => p.id === id);
          if (index !== -1) {
            MockDB.products[index] = { ...MockDB.products[index], ...data };
            return true;
          }
          return false;
        },

        // US04: Xóa mềm sản phẩm
        deleteProduct: (id) => {
          const p = MockDB.products.find((p) => p.id === id);
          if (p) {
            p.isActive = false;
            return true;
          }
          return false;
        },

        // US05, US06, US15: Xử lý giao dịch
        processTransaction: (type, productId, quantity, price, note) => {
          const product = MockDB.products.find((p) => p.id === productId);
          if (!product) throw new Error("Sản phẩm không tồn tại");

          // Check logic số lượng
          if (type === "OUT" && product.quantity < quantity) {
            throw new Error("Số lượng tồn kho không đủ để xuất!");
          }

          // Cập nhật tồn kho (Stock Update)
          if (type === "IN" || type === "RETURN") {
            product.quantity += parseInt(quantity);
            // Cập nhật giá vốn mới nếu là nhập (Trung bình cộng giản lược hoặc lấy giá mới nhất - Ở đây dùng giá mới nhất cho US02 update cost)
            if (type === "IN") product.cost = parseInt(price);
          } else if (type === "OUT") {
            product.quantity -= parseInt(quantity);
          }

          // Lưu lịch sử (Stock Card)
          const transaction = {
            id: Utils.generateId(),
            type,
            productId,
            quantity: parseInt(quantity),
            price: parseInt(price),
            date: new Date().toISOString(),
            note,
          };
          MockDB.transactions.unshift(transaction); // Thêm vào đầu mảng

          return transaction;
        },

        // US10: Điều chỉnh kho (Stocktake)
        adjustStock: (productId, realQuantity) => {
          const product = MockDB.products.find((p) => p.id === productId);
          if (!product) return;

          const diff = realQuantity - product.quantity;
          if (diff === 0) return;

          const type = diff > 0 ? "IN" : "OUT";
          const quantity = Math.abs(diff);

          // Ghi nhận giao dịch điều chỉnh
          InventoryService.processTransaction(
            type,
            productId,
            quantity,
            product.cost,
            "Kiểm kê kho (Auto Adjustment)"
          );
        },

        // US19: Lấy lịch sử sản phẩm
        getProductHistory: (productId) => {
          return MockDB.transactions.filter((t) => t.productId === productId);
        },

        // US18: Lấy dữ liệu thống kê
        getDashboardStats: () => {
          const activeProducts = MockDB.products.filter((p) => p.isActive);
          const totalItems = activeProducts.length;

          // Tổng giá trị = sum(quantity * cost)
          const totalValue = activeProducts.reduce(
            (sum, p) => sum + p.quantity * p.cost,
            0
          );

          // Cảnh báo hết hàng (US09) - Giả sử < 5 là thấp
          const lowStock = activeProducts.filter((p) => p.quantity < 5).length;

          // 5 giao dịch gần nhất
          const recentTransactions = MockDB.transactions
            .slice(0, 5)
            .map((t) => {
              const p = MockDB.products.find((prod) => prod.id === t.productId);
              return { ...t, productName: p ? p.name : "Unknown" };
            });

          return { totalItems, totalValue, lowStock, recentTransactions };
        },

        // US20: Export Excel
        exportToExcel: () => {
          const data = MockDB.products
            .filter((p) => p.isActive)
            .map((p) => ({
              SKU: p.sku,
              Name: p.name,
              Category: p.category,
              Cost: p.cost,
              Price: p.price,
              Quantity: p.quantity,
              Value: p.cost * p.quantity,
            }));

          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Inventory");
          XLSX.writeFile(wb, "Inventory_Report.xlsx");
          Utils.showToast("Đã tải xuống file báo cáo Excel!");
        },
      };

      /**
       * =========================================================================
       * CONTROLLER / UI LAYER
       * Xử lý hiển thị và sự kiện
       * =========================================================================
       */

      const App = {
        currentView: "dashboard",

        init: () => {
          App.navigate("dashboard");
          // Refresh data interval (Optional simulation)
          setInterval(() => {
            if (App.currentView === "dashboard") DashboardController.render();
          }, 30000);
        },

        navigate: (viewId) => {
          App.currentView = viewId;

          // Update UI Sidebar
          document
            .querySelectorAll(".sidebar-item")
            .forEach((el) => el.classList.remove("active"));
          const navItem = document.getElementById(`nav-${viewId}`);
          if (navItem) navItem.classList.add("active");

          // Hide all views
          ["dashboard", "products", "transactions", "stocktake"].forEach(
            (id) => {
              document.getElementById(`view-${id}`).classList.add("hidden");
            }
          );

          // Show selected view & Trigger Controller
          document.getElementById(`view-${viewId}`).classList.remove("hidden");

          if (viewId === "dashboard") DashboardController.render();
          if (viewId === "products") ProductController.render();
          if (viewId === "transactions") TransactionController.init();
          if (viewId === "stocktake") StocktakeController.render();
        },
      };

      // --- DASHBOARD CONTROLLER ---
      const DashboardController = {
        render: () => {
          const stats = InventoryService.getDashboardStats();

          document.getElementById("dash-total-value").textContent =
            Utils.formatCurrency(stats.totalValue);
          document.getElementById("dash-total-items").textContent =
            stats.totalItems;
          document.getElementById("dash-low-stock").textContent =
            stats.lowStock;

          const tbody = document.getElementById("dash-history-list");
          tbody.innerHTML = stats.recentTransactions
            .map(
              (t) => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-3 text-gray-500">#${t.id}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs font-bold ${
                              t.type === "IN" || t.type === "RETURN"
                                ? "bg-green-100 text-green-700"
                                : "bg-red-100 text-red-700"
                            }">${
                t.type === "IN"
                  ? "NHẬP"
                  : t.type === "RETURN"
                  ? "KHÁCH TRẢ"
                  : "XUẤT"
              }</span>
                        </td>
                        <td class="p-3 font-medium">${t.productName}</td>
                        <td class="p-3 text-right font-bold">${t.quantity}</td>
                        <td class="p-3 text-right text-gray-400 text-xs">${Utils.formatDate(
                          t.date
                        )}</td>
                    </tr>
                `
            )
            .join("");
        },
      };

      // --- PRODUCT CONTROLLER ---
      const ProductController = {
        isEditing: false,

        render: () => {
          const filter = document.getElementById("product-search").value;
          const products = InventoryService.getProducts(filter);
          const tbody = document.getElementById("product-list-body");

          if (products.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7" class="p-6 text-center text-gray-500">Không tìm thấy sản phẩm nào</td></tr>';
            return;
          }

          tbody.innerHTML = products
            .map(
              (p) => `
                    <tr class="hover:bg-blue-50 transition-colors group">
                        <td class="p-4 font-bold text-gray-600">${p.sku}</td>
                        <td class="p-4 font-medium text-primary">${p.name}</td>
                        <td class="p-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${
                          p.category
                        }</span></td>
                        <td class="p-4 text-right text-gray-500">${Utils.formatCurrency(
                          p.cost
                        )}</td>
                        <td class="p-4 text-right font-bold">${Utils.formatCurrency(
                          p.price
                        )}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold ${
                              p.quantity < 5
                                ? "bg-red-100 text-red-700"
                                : "bg-green-100 text-green-700"
                            }">
                                ${p.quantity} ${p.unit}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="ProductController.edit('${
                              p.id
                            }')" class="text-blue-500 hover:text-blue-700 mx-1" title="Sửa (US02)"><i class="fas fa-edit"></i></button>
                            <button onclick="ProductController.delete('${
                              p.id
                            }')" class="text-red-400 hover:text-red-600 mx-1" title="Xóa (US04)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `
            )
            .join("");
        },

        openModal: () => {
          ProductController.isEditing = false;
          document.getElementById("product-form").reset();
          document.getElementById("modal-product-title").textContent =
            "Thêm sản phẩm mới (US01)";
          document.getElementById("modal-product").classList.remove("hidden");
        },

        closeModal: () => {
          document.getElementById("modal-product").classList.add("hidden");
        },

        edit: (id) => {
          const p = InventoryService.getProductById(id);
          if (!p) return;

          ProductController.isEditing = true;
          document.getElementById("modal-product-title").textContent =
            "Cập nhật sản phẩm (US02)";

          // Fill data
          document.getElementById("prod-id").value = p.id;
          document.getElementById("prod-sku").value = p.sku;
          document.getElementById("prod-name").value = p.name;
          document.getElementById("prod-category").value = p.category;
          document.getElementById("prod-cost").value = p.cost;
          document.getElementById("prod-price").value = p.price;
          document.getElementById("prod-unit").value = p.unit;

          document.getElementById("modal-product").classList.remove("hidden");
        },

        save: (e) => {
          e.preventDefault();
          const data = {
            sku: document.getElementById("prod-sku").value,
            name: document.getElementById("prod-name").value,
            category: document.getElementById("prod-category").value,
            cost: Number(document.getElementById("prod-cost").value),
            price: Number(document.getElementById("prod-price").value),
            unit: document.getElementById("prod-unit").value,
          };

          if (ProductController.isEditing) {
            const id = document.getElementById("prod-id").value;
            InventoryService.updateProduct(id, data);
            Utils.showToast("Cập nhật thành công!");
          } else {
            InventoryService.addProduct(data);
            Utils.showToast("Thêm mới thành công!");
          }

          ProductController.closeModal();
          ProductController.render();
        },

        delete: (id) => {
          if (
            confirm("Bạn có chắc muốn xóa (ngừng kinh doanh) sản phẩm này?")
          ) {
            InventoryService.deleteProduct(id);
            Utils.showToast("Đã xóa sản phẩm", "success");
            ProductController.render();
          }
        },
      };

      // Event listener for search input
      document
        .getElementById("product-search")
        .addEventListener("input", ProductController.render);

      // --- TRANSACTION CONTROLLER ---
      const TransactionController = {
        currentMode: "IN",

        init: () => {
          // Populate dropdown
          const select = document.getElementById("trans-product-id");
          const products = InventoryService.getProducts();
          select.innerHTML =
            '<option value="">-- Chọn sản phẩm --</option>' +
            products
              .map(
                (p) =>
                  `<option value="${p.id}" data-price="${p.price}" data-cost="${p.cost}" data-qty="${p.quantity}">${p.sku} - ${p.name}</option>`
              )
              .join("");

          TransactionController.setMode("IN");
        },

        setMode: (mode) => {
          TransactionController.currentMode = mode;

          // Update UI Buttons
          ["in", "out", "return"].forEach((m) => {
            const btn = document.getElementById(`btn-mode-${m}`);
            const isActive = m.toUpperCase() === mode;
            btn.className = isActive
              ? "flex-1 py-2 rounded-md font-medium text-sm transition-all bg-white shadow text-primary border-t-2 border-primary"
              : "flex-1 py-2 rounded-md font-medium text-sm transition-all text-gray-500 hover:bg-gray-200";
          });

          // Update Button Text & Logic
          const btnSubmit = document.getElementById("trans-submit-btn");
          const priceInput = document.getElementById("trans-price");

          if (mode === "IN") {
            btnSubmit.innerHTML =
              '<i class="fas fa-arrow-down mr-2"></i> Xác nhận NHẬP KHO (US05)';
            btnSubmit.className =
              "w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition-colors mt-2";
          } else if (mode === "OUT") {
            btnSubmit.innerHTML =
              '<i class="fas fa-arrow-up mr-2"></i> Xác nhận XUẤT BÁN (US06)';
            btnSubmit.className =
              "w-full bg-danger hover:bg-red-700 text-white font-bold py-3 rounded shadow transition-colors mt-2";
          } else {
            btnSubmit.innerHTML =
              '<i class="fas fa-undo mr-2"></i> Nhận KHÁCH TRẢ (US15)';
            btnSubmit.className =
              "w-full bg-warning hover:bg-yellow-700 text-white font-bold py-3 rounded shadow transition-colors mt-2";
          }

          TransactionController.onProductSelect(); // Re-trigger price fill
        },

        onProductSelect: () => {
          const select = document.getElementById("trans-product-id");
          const option = select.options[select.selectedIndex];
          const hint = document.getElementById("trans-stock-hint");
          const priceInput = document.getElementById("trans-price");
          const cardList = document.getElementById("stock-card-list");
          const cardEmpty = document.getElementById("stock-card-empty");

          if (!option.value) {
            hint.textContent = "Tồn hiện tại: -";
            priceInput.value = "";
            cardList.classList.add("hidden");
            cardEmpty.classList.remove("hidden");
            return;
          }

          const qty = option.getAttribute("data-qty");
          const cost = option.getAttribute("data-cost");
          const price = option.getAttribute("data-price");

          hint.textContent = `Tồn hiện tại: ${qty}`;

          // Auto fill price based on mode
          if (TransactionController.currentMode === "IN") {
            priceInput.value = cost;
          } else {
            priceInput.value = price;
          }

          // Load History (Stock Card - US19)
          cardList.classList.remove("hidden");
          cardEmpty.classList.add("hidden");
          const history = InventoryService.getProductHistory(option.value);

          cardList.innerHTML =
            history.length === 0
              ? '<li class="text-center text-gray-400 text-xs italic">Chưa có giao dịch nào</li>'
              : history
                  .map(
                    (h) => `
                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded border-l-4 ${
                          h.type === "OUT"
                            ? "border-red-500"
                            : "border-green-500"
                        }">
                            <div>
                                <div class="font-bold text-xs ${
                                  h.type === "OUT"
                                    ? "text-red-600"
                                    : "text-green-600"
                                }">${h.type}</div>
                                <div class="text-xs text-gray-500">${Utils.formatDate(
                                  h.date
                                )}</div>
                                <div class="text-xs italic text-gray-400 max-w-[120px] truncate">${
                                  h.note || ""
                                }</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm">${
                                  h.quantity
                                }</div>
                            </div>
                        </li>
                    `
                  )
                  .join("");
        },

        submit: (e) => {
          e.preventDefault();
          const productId = document.getElementById("trans-product-id").value;
          const quantity = document.getElementById("trans-quantity").value;
          const price = document.getElementById("trans-price").value;
          const note = document.getElementById("trans-note").value;

          try {
            InventoryService.processTransaction(
              TransactionController.currentMode,
              productId,
              quantity,
              price,
              note
            );
            Utils.showToast("Giao dịch thành công!");

            // Reset form
            document.getElementById("trans-quantity").value = "";
            document.getElementById("trans-note").value = "";

            // Refresh data
            TransactionController.init();
          } catch (error) {
            Utils.showToast(error.message, "error");
          }
        },
      };

      // --- STOCKTAKE CONTROLLER (US10) ---
      const StocktakeController = {
        render: () => {
          const products = InventoryService.getProducts();
          const tbody = document.getElementById("stocktake-list-body");

          tbody.innerHTML = products
            .map(
              (p) => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4">
                            <div class="font-bold text-gray-700">${p.name}</div>
                            <div class="text-xs text-gray-400">${p.sku}</div>
                        </td>
                        <td class="p-4 text-center font-bold text-gray-600" id="sys-qty-${p.id}">${p.quantity}</td>
                        <td class="p-4 text-center">
                            <input type="number" id="real-qty-${p.id}" value="${p.quantity}" 
                                   oninput="StocktakeController.calcDiff('${p.id}')"
                                   class="w-20 p-1 border rounded text-center focus:ring-primary outline-none">
                        </td>
                        <td class="p-4 text-center font-bold" id="diff-qty-${p.id}">0</td>
                        <td class="p-4 text-right">
                            <button onclick="StocktakeController.save('${p.id}')" class="text-sm bg-gray-100 hover:bg-primary hover:text-white px-3 py-1 rounded transition-colors text-gray-600">
                                <i class="fas fa-check"></i> Lưu
                            </button>
                        </td>
                    </tr>
                `
            )
            .join("");
        },

        calcDiff: (id) => {
          const sysQty = parseInt(
            document.getElementById(`sys-qty-${id}`).textContent
          );
          const realQty =
            parseInt(document.getElementById(`real-qty-${id}`).value) || 0;
          const diff = realQty - sysQty;

          const diffEl = document.getElementById(`diff-qty-${id}`);
          diffEl.textContent = diff > 0 ? `+${diff}` : diff;
          diffEl.className = `p-4 text-center font-bold ${
            diff !== 0 ? "text-red-500" : "text-gray-400"
          }`;
        },

        save: (id) => {
          const realQty = parseInt(
            document.getElementById(`real-qty-${id}`).value
          );
          const sysQty = parseInt(
            document.getElementById(`sys-qty-${id}`).textContent
          );

          if (realQty === sysQty) {
            Utils.showToast("Số lượng khớp, không cần điều chỉnh.", "info");
            return;
          }

          if (
            confirm(
              "Xác nhận điều chỉnh kho cho sản phẩm này? Hệ thống sẽ tự động tạo phiếu Nhập/Xuất bù trừ."
            )
          ) {
            InventoryService.adjustStock(id, realQty);
            Utils.showToast("Đã điều chỉnh kho thành công!");
            StocktakeController.render(); // Refresh UI
          }
        },
      };

      // --- INIT APP ---
      document.addEventListener("DOMContentLoaded", App.init);
    </script>
  </body>
</html>
