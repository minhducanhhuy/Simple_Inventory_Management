<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMS Enterprise - Hệ Thống Quản Lý Kho</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
                950: "#172554",
              },
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Animation classes */
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .slide-in-right {
        animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      /* Sticky Table Header */
      .table-sticky th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8fafc;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      /* Login Background */
      .login-bg {
        background-color: #f8fafc;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233b82f6' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <!-- LOGIN SCREEN -->
    <div
      id="loginScreen"
      class="fixed inset-0 z-[100] login-bg flex items-center justify-center hidden"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-100"
      >
        <div class="text-center mb-8">
          <div
            class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-brand-100 text-brand-600 mb-4"
          >
            <i class="fa-solid fa-cube text-3xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-slate-800">IMS Enterprise</h1>
          <p class="text-slate-500 text-sm mt-1">Đăng nhập để tiếp tục</p>
        </div>
        <form onsubmit="app.login(event)" class="space-y-5">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1"
              >Tên đăng nhập</label
            >
            <input
              type="text"
              name="username"
              class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
              placeholder="admin"
              required
            />
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1"
              >Mật khẩu</label
            >
            <input
              type="password"
              name="password"
              class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition"
              placeholder="••••••"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full bg-brand-600 text-white font-bold py-3 rounded-lg hover:bg-brand-700 transition shadow-lg transform active:scale-95"
          >
            Đăng Nhập
          </button>
        </form>
        <div class="mt-6 text-center text-xs text-slate-400">
          Default: admin / 123456
        </div>
      </div>
    </div>

    <!-- MAIN APP LAYOUT (Hidden until login) -->
    <div id="appLayout" class="flex h-full hidden">
      <!-- SIDEBAR NAVIGATION -->
      <aside
        class="w-64 bg-brand-950 text-white flex flex-col shadow-2xl z-20 transition-all duration-300 flex-shrink-0"
      >
        <div
          class="h-16 flex items-center px-6 border-b border-brand-800 bg-brand-950"
        >
          <i class="fa-solid fa-cube text-brand-400 text-xl mr-3"></i>
          <h1 class="text-xl font-bold tracking-wide">IMS CORE</h1>
        </div>

        <div
          class="flex-1 overflow-y-auto py-6 px-3 space-y-1"
          id="sidebarMenu"
        >
          <!-- Menu items injected via JS -->
        </div>

        <div class="p-4 border-t border-brand-800 bg-brand-950">
          <div class="flex items-center gap-3 mb-3 px-2">
            <div
              class="w-8 h-8 rounded-full bg-brand-700 flex items-center justify-center font-bold text-xs"
              id="userAvatar"
            >
              AD
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-bold truncate" id="userNameDisplay">
                Admin
              </div>
              <div class="text-xs text-brand-400 truncate" id="userRoleDisplay">
                Administrator
              </div>
            </div>
          </div>
          <button
            onclick="app.logout()"
            class="w-full py-2 text-xs text-brand-300 hover:text-white hover:bg-brand-800 rounded transition flex items-center justify-center gap-2"
          >
            <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
          </button>
        </div>
      </aside>

      <!-- MAIN CONTENT AREA -->
      <main class="flex-1 flex flex-col min-w-0 bg-slate-50">
        <!-- TOP HEADER -->
        <header
          class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10"
        >
          <h2 id="pageTitle" class="text-xl font-bold text-slate-800">
            Tổng quan
          </h2>

          <div class="flex items-center gap-4">
            <!-- Global Search -->
            <div class="relative group">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i
                  class="fa-solid fa-search text-slate-400 group-focus-within:text-brand-500"
                ></i>
              </div>
              <input
                type="text"
                id="globalSearch"
                placeholder="Tìm kiếm nhanh (Ctrl+K)"
                class="bg-slate-100 border-none rounded-full py-2 pl-10 pr-4 text-sm w-64 focus:ring-2 focus:ring-brand-500 transition-all focus:w-80 outline-none"
              />
            </div>

            <!-- Actions -->
            <div class="relative group">
              <button
                class="p-2 text-slate-500 hover:bg-slate-100 rounded-full transition"
              >
                <i class="fa-solid fa-gear"></i>
              </button>
              <div
                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-100 hidden group-hover:block z-50 py-1"
              >
                <a
                  href="#"
                  onclick="app.openChangePasswordModal()"
                  class="block px-4 py-2 hover:bg-slate-50 text-sm text-slate-700"
                  ><i class="fa-solid fa-key mr-2"></i> Đổi mật khẩu</a
                >
                <a
                  href="#"
                  onclick="app.resetData()"
                  class="block px-4 py-2 hover:bg-red-50 text-sm text-red-600"
                  ><i class="fa-solid fa-trash-can mr-2"></i> Reset Data</a
                >
              </div>
            </div>
          </div>
        </header>

        <!-- DYNAMIC VIEW CONTAINER -->
        <div id="viewContainer" class="flex-1 overflow-auto p-6 relative">
          <!-- Content will be injected here -->
        </div>
      </main>
    </div>

    <!-- MODALS -->
    <div
      id="modalOverlay"
      class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[80] backdrop-blur-sm transition-opacity opacity-0"
    >
      <div
        id="modalContent"
        class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform scale-95 transition-all duration-200 opacity-0 max-h-[90vh] overflow-hidden flex flex-col"
      >
        <!-- Modal injected content -->
      </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div
      id="toastContainer"
      class="fixed top-6 right-6 z-[90] flex flex-col gap-3"
    ></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      /** * =================================================================
       * CORE UTILITIES & CONSTANTS
       * =================================================================
       */
      const UTILS = {
        formatCurrency: (amount) =>
          new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(amount),
        formatDate: (dateStr) =>
          new Date(dateStr).toLocaleString("vi-VN", { hour12: false }),
        generateId: (prefix = "ID") =>
          `${prefix}-${Date.now().toString(36).toUpperCase()}-${Math.random()
            .toString(36)
            .substr(2, 5)
            .toUpperCase()}`,

        showToast: (message, type = "success") => {
          const container = document.getElementById("toastContainer");
          const el = document.createElement("div");
          const icons = {
            success: "fa-circle-check",
            error: "fa-circle-xmark",
            warning: "fa-circle-exclamation",
            info: "fa-circle-info",
          };
          const colors = {
            success: "bg-emerald-500",
            error: "bg-rose-500",
            warning: "bg-amber-500",
            info: "bg-blue-500",
          };

          el.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[320px] slide-in-right transform transition-all duration-500`;
          el.innerHTML = `<i class="fa-solid ${icons[type]} text-lg"></i><div class="font-medium text-sm">${message}</div>`;

          container.appendChild(el);
          setTimeout(() => {
            el.style.opacity = "0";
            el.style.transform = "translateX(100%)";
          }, 4000);
          setTimeout(() => el.remove(), 4500);
        },

        exportToCSV: (filename, rows) => {
          const processRow = (row) =>
            row
              .map((val) => `"${val.toString().replace(/"/g, '""')}"`)
              .join(",");
          const csvContent = "\uFEFF" + rows.map(processRow).join("\n");
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");
          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        },
      };

      const ROLES = {
        ADMIN: {
          label: "Administrator",
          color: "bg-purple-100 text-purple-700",
        },
        MANAGER: { label: "Quản Lý", color: "bg-blue-100 text-blue-700" },
        STAFF: {
          label: "Nhân Viên Thủ kho",
          color: "bg-slate-100 text-slate-700",
        },
      };

      const TX_TYPES = {
        IMPORT: {
          label: "Nhập Kho",
          color: "text-emerald-600",
          bg: "bg-emerald-100",
          sign: 1,
        },
        EXPORT: {
          label: "Xuất Bán",
          color: "text-blue-600",
          bg: "bg-blue-100",
          sign: -1,
        },
        RETURN: {
          label: "Khách Trả",
          color: "text-purple-600",
          bg: "bg-purple-100",
          sign: 1,
        },
        DAMAGE: {
          label: "Hủy / Thanh Lý",
          color: "text-rose-600",
          bg: "bg-rose-100",
          sign: -1,
        },
        STOCKTAKE: {
          label: "Kiểm Kê",
          color: "text-amber-600",
          bg: "bg-amber-100",
          sign: 0,
        },
        // Mới thêm
        TRANSFER: {
          label: "Chuyển Kho",
          color: "text-indigo-600",
          bg: "bg-indigo-100",
          sign: -1,
        }, // US08
        RETURN_SUPPLIER: {
          label: "Trả Hàng NCC",
          color: "text-orange-600",
          bg: "bg-orange-100",
          sign: -1,
        }, // US16
      };

      /** * =================================================================
       * DATA LAYER
       * =================================================================
       */
      class Database {
        constructor() {
          this.loadData();
        }

        loadData() {
          this.products =
            JSON.parse(localStorage.getItem("ims_products")) || [];
          this.transactions =
            JSON.parse(localStorage.getItem("ims_transactions")) || [];
          this.users = JSON.parse(localStorage.getItem("ims_users")) || [
            {
              id: "USR-ADMIN",
              username: "admin",
              password: "123456",
              role: "ADMIN",
              fullname: "Administrator",
              active: true,
            },
          ];

          // US12, US13, US14: Khởi tạo dữ liệu đối tác
          this.suppliers =
            JSON.parse(localStorage.getItem("ims_suppliers")) || [];
          this.customers =
            JSON.parse(localStorage.getItem("ims_customers")) || [];

          this.settings = JSON.parse(localStorage.getItem("ims_settings")) || {
            categories: [
              "Điện Tử",
              "Gia Dụng",
              "Thực Phẩm",
              "Thời Trang",
              "Khác",
            ],
            units: ["Cái", "Hộp", "Thùng", "Kg", "Bộ"],
            branches: ["Chi nhánh chính", "Kho Phụ A", "Cửa hàng Quận 1"], // Cho US08
          };
        }

        save(key) {
          if (key === "users")
            localStorage.setItem("ims_users", JSON.stringify(this.users));
          else if (key === "settings")
            localStorage.setItem("ims_settings", JSON.stringify(this.settings));
          else if (key === "suppliers")
            localStorage.setItem(
              "ims_suppliers",
              JSON.stringify(this.suppliers)
            );
          // Save NCC
          else if (key === "customers")
            localStorage.setItem(
              "ims_customers",
              JSON.stringify(this.customers)
            );
          // Save Khách
          else {
            localStorage.setItem("ims_products", JSON.stringify(this.products));
            localStorage.setItem(
              "ims_transactions",
              JSON.stringify(this.transactions)
            );
          }
        }

        reset() {
          localStorage.clear();
          location.reload();
        }

        // --- SUPPLIER & CUSTOMER METHODS ---
        addPartner(type, data) {
          // type: 'suppliers' or 'customers'
          const id = UTILS.generateId(type === "suppliers" ? "SUP" : "CUS");
          const newPartner = { id, ...data, debt: 0, totalSpent: 0 };
          this[type].push(newPartner);
          this.save(type);
          return newPartner;
        }

        updatePartnerDebt(type, id, amount) {
          const p = this[type].find((x) => x.id === id);
          if (p) {
            p.debt = (p.debt || 0) + amount; // US13: Cộng nợ
            if (type === "customers")
              p.totalSpent = (p.totalSpent || 0) + Math.abs(amount);
            this.save(type);
          }
        }

        // --- PRODUCT METHODS ---
        getProducts(filterDeleted = true) {
          return filterDeleted
            ? this.products.filter((p) => !p.isDeleted)
            : this.products;
        }

        getProduct(id) {
          return this.products.find((p) => p.id === id);
        }

        addProduct(data) {
          if (this.products.some((p) => p.sku === data.sku && !p.isDeleted))
            throw new Error("Mã SKU đã tồn tại!");
          const newProduct = {
            id: UTILS.generateId("PRD"),
            ...data,
            currentStock: 0,
            isDeleted: false,
            createdAt: new Date().toISOString(),
          };
          this.products.push(newProduct);
          this.save();
          return newProduct;
        }

        updateProduct(id, data) {
          const idx = this.products.findIndex((p) => p.id === id);
          if (idx === -1) throw new Error("Không tìm thấy sản phẩm");
          delete data.currentStock; // Safety
          delete data.sku;
          this.products[idx] = { ...this.products[idx], ...data };
          this.save();
        }

        deleteProduct(id) {
          const p = this.getProduct(id);
          if (p) {
            p.isDeleted = true;
            this.save();
          }
        }

        // --- TRANSACTION METHODS ---
        addTransaction(type, items, meta = {}) {
          // 1. Xác định trạng thái
          const isStaffDamage = meta.role === "STAFF" && type === "DAMAGE";
          const status = isStaffDamage ? "PENDING" : "COMPLETED";

          // 2. Chỉ trừ kho nếu KHÔNG PHẢI là phiếu chờ duyệt
          if (status === "COMPLETED") {
            if (["EXPORT", "DAMAGE"].includes(type)) {
              items.forEach((item) => {
                const p = this.getProduct(item.productId);
                if (p.currentStock < item.quantity)
                  throw new Error(
                    `SP ${p.name} không đủ tồn kho (Còn: ${p.currentStock})`
                  );
              });
            }
          }

          const txId = UTILS.generateId("TX");
          const totalValue = items.reduce(
            (sum, i) => sum + i.price * i.quantity,
            0
          );

          const transaction = {
            id: txId,
            type,
            status: meta.status || "COMPLETED", // Status có thể truyền từ App
            date: new Date().toISOString(),
            items: items.map((i) => ({ ...i })),
            totalValue: totalValue,
            reason: meta.reason || "",
            createdBy: meta.user || "System",

            // Lưu thêm thông tin mở rộng
            supplierId: meta.supplierId || null, // US13
            customerId: meta.customerId || null, // US14
            targetLocation: meta.targetLocation || null, // US08
          };

          // LOGIC CẬP NHẬT KHO & CÔNG NỢ (Chỉ chạy khi status Completed)
          if (transaction.status === "COMPLETED") {
            // 1. Trừ/Cộng kho
            items.forEach((item) => {
              const p = this.getProduct(item.productId);
              let change = 0;
              if (type === "STOCKTAKE") change = item.quantity - p.currentStock;
              else change = item.quantity * TX_TYPES[type].sign;

              p.currentStock += change;
              item.snapshotStock = p.currentStock;
              item.change = change;
            });

            // 2. Xử lý Công nợ NCC (US13, US16)
            if (meta.supplierId) {
              // Nhập hàng: Tăng nợ | Trả hàng NCC: Giảm nợ
              const debtChange =
                type === "IMPORT"
                  ? totalValue
                  : type === "RETURN_SUPPLIER"
                  ? -totalValue
                  : 0;
              this.updatePartnerDebt("suppliers", meta.supplierId, debtChange);
            }

            // 3. Xử lý Khách hàng (US14)
            if (meta.customerId && type === "EXPORT") {
              this.updatePartnerDebt("customers", meta.customerId, totalValue);
            }
          }

          this.transactions.unshift(transaction);
          this.save();
          return transaction;
        }

        // Thêm hàm duyệt mới trong Database
        approveTransaction(txId) {
          const tx = this.transactions.find((t) => t.id === txId);
          if (!tx || tx.status !== "PENDING")
            throw new Error("Giao dịch không hợp lệ");

          // Thực hiện trừ kho bù
          tx.items.forEach((item) => {
            const p = this.getProduct(item.productId);
            // Kiểm tra lại tồn kho
            if (p.currentStock < item.quantity)
              throw new Error(`SP ${p.name} không đủ để duyệt hủy!`);

            const change = item.quantity * -1; // DAMAGE luôn là trừ
            p.currentStock += change;
            item.snapshotStock = p.currentStock;
            item.change = change;
          });

          tx.status = "COMPLETED";
          this.save();
        }
        // --- USER & SETTINGS METHODS ---
        getUser(username) {
          return this.users.find((u) => u.username === username);
        }

        addUser(data) {
          if (this.getUser(data.username))
            throw new Error("Tên đăng nhập đã tồn tại!");
          this.users.push({
            id: UTILS.generateId("USR"),
            ...data,
            active: true,
          });
          this.save("users");
        }

        updateUser(id, data) {
          const idx = this.users.findIndex((u) => u.id === id);
          if (idx === -1) throw new Error("User not found");
          this.users[idx] = { ...this.users[idx], ...data };
          this.save("users");
        }

        updateSettings(type, action, value) {
          if (type === "categories") {
            if (action === "add") this.settings.categories.push(value);
            if (action === "remove")
              this.settings.categories = this.settings.categories.filter(
                (c) => c !== value
              );
          } else if (type === "units") {
            if (action === "add") this.settings.units.push(value);
            if (action === "remove")
              this.settings.units = this.settings.units.filter(
                (u) => u !== value
              );
          }
          this.save("settings");
        }
      }

      /** * =================================================================
       * UI MANAGER (Controller)
       * =================================================================
       */
      class App {
        constructor() {
          this.db = new Database();
          this.currentUser =
            JSON.parse(sessionStorage.getItem("ims_current_user")) || null;
          this.currentView = "DASHBOARD";
          this.cart = [];

          this.init();
        }

        init() {
          if (!this.currentUser) {
            this.showLogin();
          } else {
            this.showMainApp();
          }

          document
            .getElementById("globalSearch")
            .addEventListener("input", (e) => {
              if (this.currentView === "PRODUCTS")
                this.renderProductList(e.target.value);
            });
        }

        // --- AUTH SYSTEM ---
        showLogin() {
          document.getElementById("loginScreen").classList.remove("hidden");
          document.getElementById("appLayout").classList.add("hidden");
        }

        showMainApp() {
          document.getElementById("loginScreen").classList.add("hidden");
          document.getElementById("appLayout").classList.remove("hidden");

          // Render User Info
          document.getElementById("userNameDisplay").textContent =
            this.currentUser.fullname;
          document.getElementById("userRoleDisplay").textContent =
            ROLES[this.currentUser.role]?.label || this.currentUser.role;
          document.getElementById("userAvatar").textContent =
            this.currentUser.fullname.substring(0, 2).toUpperCase();

          this.renderSidebar();
          this.navigate("DASHBOARD");
        }

        login(e) {
          e.preventDefault();
          const form = new FormData(e.target);
          const user = this.db.getUser(form.get("username"));

          if (user && user.password === form.get("password") && user.active) {
            this.currentUser = user;
            sessionStorage.setItem("ims_current_user", JSON.stringify(user));
            UTILS.showToast(`Chào mừng, ${user.fullname}!`);
            this.showMainApp();
          } else {
            UTILS.showToast(
              "Sai tên đăng nhập, mật khẩu hoặc tài khoản bị khóa!",
              "error"
            );
          }
        }

        logout() {
          this.currentUser = null;
          sessionStorage.removeItem("ims_current_user");
          this.showLogin();
        }

        openChangePasswordModal() {
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");
          content.innerHTML = `
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                   <h3 class="font-bold text-lg text-slate-800">Đổi Mật Khẩu</h3>
                   <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <form id="changePassForm" class="p-6 space-y-4">
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mật khẩu cũ</label>
                       <input type="password" name="oldPass" class="w-full border rounded p-2" required>
                   </div>
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mật khẩu mới</label>
                       <input type="password" name="newPass" class="w-full border rounded p-2" required>
                   </div>
                   <button type="submit" class="w-full bg-brand-600 text-white font-bold py-2 rounded">Cập nhật</button>
                </form>
            `;
          this._showModal(overlay, content);
          document.getElementById("changePassForm").onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            if (this.currentUser.password !== formData.get("oldPass"))
              return UTILS.showToast("Mật khẩu cũ không đúng", "error");

            this.db.updateUser(this.currentUser.id, {
              password: formData.get("newPass"),
            });
            this.currentUser.password = formData.get("newPass"); // Update session
            sessionStorage.setItem(
              "ims_current_user",
              JSON.stringify(this.currentUser)
            );
            UTILS.showToast("Đổi mật khẩu thành công!");
            this.closeModal();
          };
        }

        // --- NAVIGATION ---
        renderSidebar() {
          const menu = document.getElementById("sidebarMenu");
          menu.innerHTML = "";

          const isAdmin = this.currentUser.role === "ADMIN";

          // 1. Tổng quan
          this._addSidebarHeader(menu, "Tổng quan");
          this._addSidebarItem(menu, "DASHBOARD", "fa-chart-pie", "Dashboard");

          // 2. Quản lý kho
          this._addSidebarHeader(menu, "Quản lý kho", "mt-6");
          this._addSidebarItem(
            menu,
            "PRODUCTS",
            "fa-boxes-stacked",
            "Sản phẩm"
          );
          this._addSidebarItem(menu, "IMPORT", "fa-dolly", "Nhập kho");
          this._addSidebarItem(menu, "EXPORT", "fa-cart-shopping", "Xuất bán");

          // Sau mục "Quản lý kho", thêm:
          this._addSidebarHeader(menu, "Đối tác (US12,13,14)", "mt-6");
          this._addSidebarItem(
            menu,
            "SUPPLIERS",
            "fa-truck-field",
            "Nhà cung cấp"
          );
          this._addSidebarItem(
            menu,
            "CUSTOMERS",
            "fa-users-line",
            "Khách hàng"
          );

          // Trong mục "Vận hành", thêm:
          this._addSidebarItem(
            menu,
            "TRANSFER",
            "fa-truck-arrow-right",
            "Chuyển kho"
          ); // US08
          this._addSidebarItem(
            menu,
            "RETURN_SUPPLIER",
            "fa-reply-all",
            "Trả NCC"
          ); // US16

          // 3. Vận hành
          this._addSidebarHeader(menu, "Vận hành", "mt-6");
          this._addSidebarItem(
            menu,
            "STOCKTAKE",
            "fa-clipboard-check",
            "Kiểm kê"
          );
          this._addSidebarItem(menu, "RETURN", "fa-rotate-left", "Trả hàng");
          this._addSidebarItem(
            menu,
            "DAMAGE",
            "fa-triangle-exclamation",
            "Hủy hàng"
          );

          // 4. Báo cáo
          this._addSidebarHeader(menu, "Báo cáo", "mt-6");
          this._addSidebarItem(menu, "REPORT", "fa-file-invoice", "Lịch sử GD");

          // 5. Hệ thống (Admin Only)
          if (isAdmin) {
            this._addSidebarHeader(menu, "Hệ thống", "mt-6");
            this._addSidebarItem(menu, "USERS", "fa-users-gear", "Nhân viên");
            this._addSidebarItem(menu, "SETTINGS", "fa-sliders", "Cấu hình");
          }
        }

        _addSidebarHeader(parent, text, margin = "mb-2") {
          const div = document.createElement("div");
          div.className = `px-3 ${margin} mb-2 text-xs font-bold text-brand-400 uppercase tracking-wider`;
          div.innerText = text;
          parent.appendChild(div);
        }

        _addSidebarItem(parent, id, icon, label) {
          const btn = document.createElement("button");
          btn.onclick = () => this.navigate(id);
          btn.className = `nav-item w-full text-left px-3 py-2.5 rounded-lg hover:bg-brand-800 transition flex items-center gap-3 text-brand-100`;
          btn.setAttribute("data-id", id);
          btn.innerHTML = `<i class="fa-solid ${icon} w-5 text-center"></i> ${label}`;
          parent.appendChild(btn);
        }

        navigate(view) {
          this.currentView = view;
          this.cart = []; // Reset cart

          // Update Sidebar Active State
          document.querySelectorAll(".nav-item").forEach((el) => {
            if (el.getAttribute("data-id") === view) {
              el.classList.add("bg-brand-700", "text-white", "shadow-inner");
              el.classList.remove("text-brand-100");
            } else {
              el.classList.remove("bg-brand-700", "text-white", "shadow-inner");
              el.classList.add("text-brand-100");
            }
          });

          const container = document.getElementById("viewContainer");
          const title = document.getElementById("pageTitle");

          // Router
          switch (view) {
            case "DASHBOARD":
              title.innerText = "Tổng quan hệ thống";
              this.renderDashboard(container);
              break;
            case "PRODUCTS":
              title.innerText = "Quản lý sản phẩm";
              this.renderProductList(container);
              break;
            case "IMPORT":
            case "EXPORT":
            case "RETURN":
            case "DAMAGE":
              title.innerText = TX_TYPES[view].label;
              this.renderTransactionForm(container, view);
              break;
            case "STOCKTAKE":
              title.innerText = "Kiểm kê kho";
              this.renderStocktake(container);
              break;
            case "REPORT":
              title.innerText = "Báo cáo & Lịch sử";
              this.renderReport(container);
              break;
            // Admin Routes
            case "USERS":
              title.innerText = "Quản lý nhân viên";
              this.renderUsers(container);
              break;

            case "SUPPLIERS":
            case "CUSTOMERS":
              this.renderPartners(
                container,
                view === "SUPPLIERS" ? "suppliers" : "customers"
              );
              break;
            case "TRANSFER":
            case "RETURN_SUPPLIER":
              title.innerText = TX_TYPES[view].label;
              this.renderTransactionForm(container, view);
              break;
            case "SETTINGS":
              title.innerText = "Cấu hình hệ thống";
              this.renderSettings(container);
              break;
          }
        }

        // --- ADMIN VIEWS: USERS & SETTINGS ---
        renderUsers(container) {
          if (this.currentUser.role !== "ADMIN")
            return (container.innerHTML =
              '<p class="text-red-500">Truy cập bị từ chối</p>');

          const users = this.db.users;
          container.innerHTML = `
                <div class="flex justify-between items-center mb-6 fade-in">
                    <h3 class="font-bold text-slate-700">Danh sách nhân viên</h3>
                    <button onclick="app.openUserModal()" class="bg-brand-600 text-white px-4 py-2 rounded-lg shadow hover:bg-brand-700"><i class="fa-solid fa-plus mr-2"></i> Thêm nhân viên</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 font-bold text-slate-500 border-b border-slate-100">
                            <tr><th class="p-4">Họ tên</th><th class="p-4">Username</th><th class="p-4">Vai trò</th><th class="p-4">Trạng thái</th><th class="p-4 text-center">Thao tác</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${users
                              .map(
                                (u) => `
                                <tr class="hover:bg-slate-50">
                                    <td class="p-4 font-bold text-slate-700">${
                                      u.fullname
                                    }</td>
                                    <td class="p-4 font-mono text-slate-500">${
                                      u.username
                                    }</td>
                                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${
                                      ROLES[u.role].color
                                    }">${ROLES[u.role].label}</span></td>
                                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${
                                      u.active
                                        ? "bg-green-100 text-green-700"
                                        : "bg-red-100 text-red-700"
                                    }">${
                                  u.active ? "Hoạt động" : "Đã khóa"
                                }</span></td>
                                    <td class="p-4 text-center">
                                        <button onclick="app.openUserModal('${
                                          u.id
                                        }')" class="text-blue-600 hover:text-blue-800 mr-2" title="Sửa"><i class="fa-solid fa-pen"></i></button>
                                        ${
                                          u.username !== "admin"
                                            ? `<button onclick="app.toggleUserStatus('${
                                                u.id
                                              }')" class="${
                                                u.active
                                                  ? "text-orange-500"
                                                  : "text-green-500"
                                              }" title="${
                                                u.active ? "Khóa" : "Mở khóa"
                                              }"><i class="fa-solid ${
                                                u.active
                                                  ? "fa-lock"
                                                  : "fa-lock-open"
                                              }"></i></button>`
                                            : ""
                                        }
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;
        }

        openUserModal(id = null) {
          const isEdit = !!id;
          const u = isEdit ? this.db.users.find((x) => x.id === id) : {};
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");

          content.innerHTML = `
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                   <h3 class="font-bold text-lg text-slate-800">${
                     isEdit ? "Sửa thông tin" : "Tạo tài khoản mới"
                   }</h3>
                   <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <form id="userForm" class="p-6 space-y-4">
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Họ và tên</label>
                       <input type="text" name="fullname" value="${
                         u.fullname || ""
                       }" class="w-full border rounded p-2" required>
                   </div>
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tên đăng nhập</label>
                       <input type="text" name="username" value="${
                         u.username || ""
                       }" ${
            isEdit
              ? 'disabled class="w-full border rounded p-2 bg-slate-100"'
              : 'class="w-full border rounded p-2"'
          } required>
                   </div>
                   ${
                     !isEdit
                       ? `
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mật khẩu</label>
                       <input type="password" name="password" class="w-full border rounded p-2" required>
                   </div>`
                       : `
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mật khẩu mới (Để trống nếu không đổi)</label>
                       <input type="password" name="password" class="w-full border rounded p-2" placeholder="********">
                   </div>`
                   }
                   <div>
                       <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Vai trò</label>
                       <select name="role" class="w-full border rounded p-2">
                           ${Object.keys(ROLES)
                             .map(
                               (k) =>
                                 `<option value="${k}" ${
                                   u.role === k ? "selected" : ""
                                 }>${ROLES[k].label}</option>`
                             )
                             .join("")}
                       </select>
                   </div>
                   <button type="submit" class="w-full bg-brand-600 text-white font-bold py-2 rounded mt-4">Lưu</button>
                </form>
            `;
          this._showModal(overlay, content);

          document.getElementById("userForm").onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd);
            if (isEdit && !data.password) delete data.password; // Don't update pass if empty in edit mode

            try {
              if (isEdit) this.db.updateUser(id, data);
              else this.db.addUser(data);
              UTILS.showToast("Thành công");
              this.closeModal();
              this.renderUsers(document.getElementById("viewContainer"));
            } catch (err) {
              UTILS.showToast(err.message, "error");
            }
          };
        }

        toggleUserStatus(id) {
          const u = this.db.users.find((x) => x.id === id);
          if (
            confirm(
              `Bạn có chắc muốn ${u.active ? "KHÓA" : "MỞ KHÓA"} tài khoản này?`
            )
          ) {
            this.db.updateUser(id, { active: !u.active });
            this.renderUsers(document.getElementById("viewContainer"));
          }
        }

        renderSettings(container) {
          if (this.currentUser.role !== "ADMIN") return;
          const { categories, units } = this.db.settings;

          const renderList = (title, items, type) => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex-1">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-700">${title}</h4>
                        <form onsubmit="app.addSetting(event, '${type}')" class="flex gap-2">
                            <input name="val" placeholder="Thêm mới..." class="border rounded px-2 py-1 text-sm outline-none focus:border-brand-500" required>
                            <button class="bg-brand-100 text-brand-600 px-3 py-1 rounded text-sm hover:bg-brand-200"><i class="fa-solid fa-plus"></i></button>
                        </form>
                    </div>
                    <ul class="space-y-2">
                        ${items
                          .map(
                            (i) => `
                            <li class="flex justify-between items-center p-2 bg-slate-50 rounded group">
                                <span class="text-sm">${i}</span>
                                <button onclick="app.removeSetting('${type}', '${i}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                            </li>
                        `
                          )
                          .join("")}
                    </ul>
                </div>
            `;

          container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6 fade-in">
                    ${renderList("Danh mục sản phẩm", categories, "categories")}
                    ${renderList("Đơn vị tính", units, "units")}
                </div>
            `;
        }

        addSetting(e, type) {
          e.preventDefault();
          const val = e.target.val.value.trim();
          if (val) {
            this.db.updateSettings(type, "add", val);
            this.renderSettings(document.getElementById("viewContainer"));
          }
        }

        removeSetting(type, val) {
          if (confirm(`Xóa "${val}" khỏi danh sách?`)) {
            this.db.updateSettings(type, "remove", val);
            this.renderSettings(document.getElementById("viewContainer"));
          }
        }

        // --- DASHBOARD & PRODUCT VIEW (Updated) ---
        renderDashboard(container) {
          const products = this.db.getProducts();
          const totalStock = products.reduce(
            (sum, p) => sum + p.currentStock,
            0
          );
          const totalValue = products.reduce(
            (sum, p) => sum + p.currentStock * p.costPrice,
            0
          );
          const lowStock = products.filter((p) => p.currentStock <= p.minStock);
          const recentTx = this.db.transactions.slice(0, 5);

          container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
              <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center">
                <div class="p-4 rounded-full bg-blue-50 text-brand-600 mr-4"><i class="fa-solid fa-cubes text-2xl"></i></div>
                <div>
                  <div class="text-sm text-slate-500 font-medium">Tổng tồn kho</div>
                  <div class="text-2xl font-bold text-slate-800">${UTILS.formatCurrency(
                    totalStock
                  ).replace(
                    "₫",
                    ""
                  )} <span class="text-xs font-normal text-slate-400">đơn vị</span></div>
                </div>
              </div>
              <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center">
                <div class="p-4 rounded-full bg-emerald-50 text-emerald-600 mr-4"><i class="fa-solid fa-sack-dollar text-2xl"></i></div>
                <div>
                  <div class="text-sm text-slate-500 font-medium">Giá trị kho</div>
                  <div class="text-2xl font-bold text-slate-800">${UTILS.formatCurrency(
                    totalValue
                  )}</div>
                </div>
              </div>
              <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center cursor-pointer hover:bg-rose-50 transition" onclick="app.navigate('PRODUCTS')">
                <div class="p-4 rounded-full bg-rose-50 text-rose-600 mr-4 relative">
                  <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                  ${
                    lowStock.length > 0
                      ? '<span class="absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full animate-ping"></span>'
                      : ""
                  }
                </div>
                <div>
                  <div class="text-sm text-slate-500 font-medium">Cảnh báo tồn thấp (US09)</div>
                  <div class="text-2xl font-bold text-rose-600">${
                    lowStock.length
                  } <span class="text-xs font-normal text-slate-400">sản phẩm</span></div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
              <!-- Chart -->
              <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4">Phân bổ tồn kho theo danh mục</h3>
                <div class="h-64"><canvas id="dashboardChart"></canvas></div>
              </div>

              <!-- Recent Activity -->
              <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4">Giao dịch gần đây</h3>
                <div class="space-y-4">
                  ${
                    recentTx.length === 0
                      ? '<div class="text-center text-slate-400 py-4">Chưa có giao dịch</div>'
                      : recentTx
                          .map(
                            (tx) => `
                    <div class="flex items-center justify-between pb-3 border-b border-slate-50 last:border-0">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${
                          TX_TYPES[tx.type].bg
                        } ${
                              TX_TYPES[tx.type].color
                            } flex items-center justify-center text-sm font-bold">
                          ${tx.type.substr(0, 1)}
                        </div>
                        <div>
                          <div class="text-sm font-bold text-slate-700">${
                            TX_TYPES[tx.type].label
                          }</div>
                          <div class="text-xs text-slate-400">${UTILS.formatDate(
                            tx.date
                          )}</div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-sm font-medium">${UTILS.formatCurrency(
                          tx.totalValue
                        )}</div>
                        <div class="text-xs text-slate-400">${
                          tx.items.length
                        } items</div>
                      </div>
                    </div>
                  `
                          )
                          .join("")
                  }
                </div>
                <button onclick="app.navigate('REPORT')" class="w-full mt-4 py-2 text-sm text-brand-600 bg-brand-50 rounded-lg hover:bg-brand-100 transition">Xem tất cả</button>
              </div>
            </div>
          `;

          setTimeout(() => {
            const ctx = document
              .getElementById("dashboardChart")
              .getContext("2d");
            const catData = {};
            this.db.getProducts().forEach((p) => {
              catData[p.category] = (catData[p.category] || 0) + p.currentStock;
            });
            new Chart(ctx, {
              type: "bar",
              data: {
                labels: Object.keys(catData),
                datasets: [
                  {
                    label: "Tồn kho",
                    data: Object.values(catData),
                    backgroundColor: "#3b82f6",
                    borderRadius: 4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
              },
            });
          }, 0);
        }

        renderProductList(containerOrKeyword) {
          let container, products;
          if (typeof containerOrKeyword === "string") {
            container = document.querySelector("#productTableBody");
            const kw = containerOrKeyword.toLowerCase();
            products = this.db
              .getProducts()
              .filter(
                (p) =>
                  p.name.toLowerCase().includes(kw) ||
                  p.sku.toLowerCase().includes(kw)
              );
            if (container)
              container.innerHTML = this._generateProductRows(products);
            return;
          }

          container = containerOrKeyword;
          products = this.db.getProducts();

          container.innerHTML = `
            <div class="flex justify-between items-center mb-6 fade-in">
              <div class="flex gap-2">
                <button onclick="app.openProductModal()" class="bg-brand-600 text-white px-5 py-2.5 rounded-lg shadow-lg hover:bg-brand-700 hover:shadow-xl transition flex items-center gap-2">
                  <i class="fa-solid fa-plus"></i> Thêm Sản Phẩm (US01)
                </button>
                <div class="relative group">
                  <button class="bg-white border border-slate-200 text-slate-600 px-5 py-2.5 rounded-lg shadow-sm hover:bg-slate-50 transition flex items-center gap-2">
                    <i class="fa-solid fa-filter"></i> Lọc Danh Mục (US03)
                  </button>
                  <div class="absolute top-full left-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-100 hidden group-hover:block z-20 py-1">
                    <a href="#" onclick="app.renderProductList(document.getElementById('viewContainer'))" class="block px-4 py-2 hover:bg-slate-50 text-sm">Tất cả</a>
                    ${this.db.settings.categories
                      .map(
                        (c) =>
                          `<a href="#" onclick="app.filterCategory('${c}')" class="block px-4 py-2 hover:bg-slate-50 text-sm">${c}</a>`
                      )
                      .join("")}
                  </div>
                </div>
              </div>
              <button onclick="app.exportExcel()" class="text-emerald-600 bg-emerald-50 px-5 py-2.5 rounded-lg border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-2">
                <i class="fa-solid fa-file-excel"></i> Xuất Excel (US20)
              </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in flex flex-col h-[calc(100vh-220px)]">
              <div class="overflow-auto flex-1">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                    <tr>
                      <th class="p-4 w-16">Hình</th>
                      <th class="p-4">Thông tin SP</th>
                      <th class="p-4 text-center">Danh mục</th>
                      <th class="p-4 text-right">Giá vốn</th>
                      <th class="p-4 text-right">Giá bán</th>
                      <th class="p-4 text-center">Tồn kho</th>
                      <th class="p-4 text-center">Thao tác</th>
                    </tr>
                  </thead>
                  <tbody id="productTableBody" class="divide-y divide-slate-100 text-sm text-slate-700">
                    ${this._generateProductRows(products)}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        _generateProductRows(products) {
          if (products.length === 0)
            return `<tr><td colspan="7" class="p-8 text-center text-slate-400">Không tìm thấy dữ liệu phù hợp</td></tr>`;
          return products
            .map((p) => {
              const isLow = p.currentStock <= p.minStock;
              return `
              <tr class="hover:bg-slate-50 transition group">
                <td class="p-4">
                  <div class="w-10 h-10 rounded bg-slate-200 flex items-center justify-center text-slate-400 text-xs overflow-hidden">
                    ${
                      p.image
                        ? `<img src="${p.image}" class="w-full h-full object-cover" onerror="this.style.display='none'">`
                        : '<i class="fa-solid fa-image"></i>'
                    }
                  </div>
                </td>
                <td class="p-4">
                  <div class="font-bold text-slate-800">${p.name}</div>
                  <div class="text-xs text-slate-500 font-mono">${p.sku}</div>
                </td>
                <td class="p-4 text-center"><span class="px-2 py-1 rounded-full bg-slate-100 text-xs text-slate-600">${
                  p.category
                }</span></td>
                <td class="p-4 text-right font-medium">${UTILS.formatCurrency(
                  p.costPrice
                )}</td>
                <td class="p-4 text-right font-medium text-brand-600">${UTILS.formatCurrency(
                  p.sellingPrice
                )}</td>
                <td class="p-4 text-center">
                  <div class="flex flex-col items-center">
                    <span class="font-bold ${
                      isLow ? "text-rose-600" : "text-emerald-600"
                    }">${p.currentStock}</span>
                    ${
                      isLow
                        ? `<span class="text-[10px] text-rose-500 bg-rose-50 px-1 rounded mt-1">Dưới mức min (${p.minStock})</span>`
                        : ""
                    }
                  </div>
                </td>
                <td class="p-4 text-center">
                  <div class="flex justify-center gap-2 opacity-60 group-hover:opacity-100 transition">
                    <button onclick="app.showProductHistory('${
                      p.id
                    }')" title="Lịch sử (US19)" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100"><i class="fa-solid fa-clock-rotate-left"></i></button>
                    ${
                      this.currentUser.role !== "STAFF"
                        ? `
                    <button onclick="app.openProductModal('${p.id}')" title="Sửa (US02)" class="w-8 h-8 rounded-full bg-amber-50 text-amber-600 hover:bg-amber-100"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="app.softDeleteProduct('${p.id}')" title="Xóa (US04)" class="w-8 h-8 rounded-full bg-rose-50 text-rose-600 hover:bg-rose-100"><i class="fa-solid fa-trash"></i></button>
                    `
                        : ""
                    }
                  </div>
                </td>
              </tr>
            `;
            })
            .join("");
        }

        filterCategory(cat) {
          const products = this.db
            .getProducts()
            .filter((p) => p.category === cat);
          document.querySelector("#productTableBody").innerHTML =
            this._generateProductRows(products);
        }

        // --- VIEW: TRANSACTION FORMS ---
        renderTransactionForm(container, type) {
          const config = TX_TYPES[type];
          const products = this.db.getProducts();

          // --- PHẦN LOGIC MỚI: Xây dựng các ô nhập liệu động ---
          let extraFieldsHTML = "";

          // 1. Nếu là Nhập kho hoặc Trả hàng NCC -> Hiện chọn Nhà Cung Cấp (US12, US13, US16)
          if (["IMPORT", "RETURN_SUPPLIER"].includes(type)) {
            const suppliers = this.db.suppliers || [];
            extraFieldsHTML += `
            <div class="mb-3">
                <div class="text-xs font-bold text-slate-500 uppercase mb-1">Nhà cung cấp (US12,13)</div>
                <select id="txPartner" class="w-full text-sm border border-slate-300 rounded p-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="">-- Khách lẻ / Vãng lai --</option>
                    ${suppliers
                      .map((s) => `<option value="${s.id}">${s.name}</option>`)
                      .join("")}
                </select>
            </div>
        `;
          }

          // 2. Nếu là Xuất bán -> Hiện chọn Khách Hàng (US14)
          if (type === "EXPORT") {
            const customers = this.db.customers || [];
            extraFieldsHTML += `
            <div class="mb-3">
                <div class="text-xs font-bold text-slate-500 uppercase mb-1">Khách hàng (US14)</div>
                <div class="flex gap-2">
                    <select id="txPartner" class="w-full text-sm border border-slate-300 rounded p-2 focus:ring-2 focus:ring-brand-500 outline-none">
                        <option value="">-- Khách lẻ --</option>
                        ${customers
                          .map(
                            (c) =>
                              `<option value="${c.id}">${c.name} - ${c.phone}</option>`
                          )
                          .join("")}
                    </select>
                    <button onclick="app.openPartnerModal('customers')" class="bg-brand-100 text-brand-600 px-3 rounded hover:bg-brand-200" title="Thêm khách hàng mới">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>
        `;
          }

          // 3. Nếu là Chuyển kho -> Hiện chọn Kho đích (US08)
          if (type === "TRANSFER") {
            const branches = this.db.settings.branches || [
              "Kho B",
              "Chi nhánh 1",
            ];
            extraFieldsHTML += `
            <div class="mb-3">
                <div class="text-xs font-bold text-slate-500 uppercase mb-1">Chuyển đến kho (US08) <span class="text-red-500">*</span></div>
                <select id="txLocation" class="w-full text-sm border border-indigo-300 bg-indigo-50 rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                    ${branches
                      .map((b) => `<option value="${b}">${b}</option>`)
                      .join("")}
                </select>
            </div>
        `;
          }

          // 4. Ô nhập Lý do / Ghi chú (Chung cho tất cả, riêng DAMAGE có select list)
          let reasonInputHTML = "";
          if (type === "DAMAGE") {
            reasonInputHTML = `
            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Lý do hủy (US07) <span class="text-red-500">*</span></div>
            <select id="txReason" class="w-full text-sm border rounded p-2 focus:ring-2 focus:ring-rose-500 outline-none">
                <option value="">-- Chọn lý do --</option>
                <option value="Hết hạn sử dụng">Hết hạn sử dụng</option>
                <option value="Hư hỏng/Vỡ">Hư hỏng/Vỡ</option>
                <option value="Lỗi sản xuất">Lỗi sản xuất</option>
                <option value="Thanh lý">Thanh lý</option>
                <option value="Khác">Khác</option>
            </select>`;
          } else {
            reasonInputHTML = `
            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Ghi chú / Lý do</div>
            <input type="text" id="txReason" placeholder="Nhập ghi chú..." class="w-full text-sm border border-slate-300 rounded p-2 focus:ring-2 focus:ring-brand-500 outline-none">`;
          }

          // --- KẾT THÚC LOGIC MỚI ---

          container.innerHTML = `
    <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-140px)] fade-in">
      <div class="lg:w-2/3 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-4 border-b border-slate-100 bg-slate-50">
          <input type="text" id="txSearch" placeholder="Tìm kiếm sản phẩm để thêm..." 
            class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
        </div>
        <div id="txProductGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 gap-4 content-start">
          ${products
            .map(
              (p) => `
            <div onclick="app.addToCart('${
              p.id
            }', '${type}')" class="group bg-white border border-slate-200 rounded-lg p-3 cursor-pointer hover:border-brand-500 hover:shadow-md transition relative overflow-hidden select-none">
              <div class="text-sm font-bold text-slate-800 truncate mb-1" title="${
                p.name
              }">${p.name}</div>
              <div class="flex justify-between items-end">
                <div class="text-xs text-slate-500 font-mono">${p.sku}</div>
                <div class="text-xs font-bold ${
                  p.currentStock <= 0 ? "text-rose-500" : "text-emerald-600"
                }">Kho: ${p.currentStock}</div>
              </div>
              <div class="absolute inset-0 bg-brand-50/20 hidden group-active:block"></div>
            </div>
          `
            )
            .join("")}
        </div>
      </div>

      <div class="lg:w-1/3 flex flex-col bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden">
        <div class="p-4 ${
          config.bg
        } border-b border-slate-100 flex items-center justify-between">
          <h3 class="font-bold ${
            config.color
          }"><i class="fa-solid fa-file-pen mr-2"></i>Phiếu ${config.label}</h3>
          <span class="text-xs bg-white px-2 py-1 rounded border border-slate-200">${new Date().toLocaleDateString()}</span>
        </div>
        
        <div class="p-4 bg-slate-50 border-b border-slate-200">
             ${extraFieldsHTML}
             ${reasonInputHTML}
        </div>
        <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-2">
          <div class="text-center text-slate-400 py-10 flex flex-col items-center">
            <i class="fa-solid fa-basket-shopping text-3xl mb-2 opacity-50"></i>
            <p>Chưa chọn sản phẩm</p>
          </div>
        </div>

        <div class="p-4 bg-slate-50 border-t border-slate-200">
          <div class="flex justify-between items-center mb-4">
            <span class="text-slate-500 font-medium">Tổng giá trị</span>
            <span id="cartTotal" class="text-xl font-bold text-slate-800">0 ₫</span>
          </div>
          <button onclick="app.submitTransaction('${type}')" class="w-full py-3 rounded-lg font-bold text-white shadow-lg transition transform active:scale-95 ${
            type === "DAMAGE"
              ? "bg-rose-600 hover:bg-rose-700"
              : "bg-brand-600 hover:bg-brand-700"
          }">
            Hoàn Tất
          </button>
        </div>
      </div>
    </div>
  `;

          // Giữ nguyên logic Search
          document.getElementById("txSearch").addEventListener("input", (e) => {
            const kw = e.target.value.toLowerCase();
            document
              .getElementById("txProductGrid")
              .childNodes.forEach((el) => {
                if (el.nodeType === 1)
                  el.style.display = el.innerText.toLowerCase().includes(kw)
                    ? "block"
                    : "none";
              });
          });
        }

        addToCart(productId, type) {
          const product = this.db.getProduct(productId);
          const price =
            type === "IMPORT" || type === "DAMAGE"
              ? product.costPrice
              : product.sellingPrice;

          const existing = this.cart.find((i) => i.productId === productId);
          if (existing) existing.quantity++;
          else
            this.cart.push({
              productId,
              quantity: 1,
              price,
              name: product.name,
              max: product.currentStock,
            });

          this.renderCart(type);
        }

        renderCart(type) {
          const container = document.getElementById("cartItems");
          const totalEl = document.getElementById("cartTotal");

          if (!this.cart.length) {
            container.innerHTML = `<div class="text-center text-slate-400 py-10 flex flex-col items-center"><i class="fa-solid fa-basket-shopping text-3xl mb-2 opacity-50"></i><p>Chưa chọn sản phẩm</p></div>`;
            totalEl.innerText = "0 ₫";
            return;
          }

          let total = 0;
          container.innerHTML = this.cart
            .map((item, idx) => {
              total += item.price * item.quantity;
              return `
              <div class="flex items-center justify-between bg-white p-2 rounded border border-slate-100 shadow-sm slide-in-right">
                <div class="flex-1 min-w-0 pr-2">
                  <div class="text-sm font-medium truncate">${item.name}</div>
                  <div class="text-xs text-slate-400">${UTILS.formatCurrency(
                    item.price
                  )}</div>
                </div>
                <div class="flex items-center bg-slate-100 rounded">
                  <button onclick="app.updateCartQty(${idx}, -1, '${type}')" class="w-6 h-6 hover:bg-slate-200 rounded text-xs"><i class="fa-solid fa-minus"></i></button>
                  <span class="w-8 text-center text-sm font-bold">${
                    item.quantity
                  }</span>
                  <button onclick="app.updateCartQty(${idx}, 1, '${type}')" class="w-6 h-6 hover:bg-slate-200 rounded text-xs"><i class="fa-solid fa-plus"></i></button>
                </div>
                <button onclick="app.removeFromCart(${idx}, '${type}')" class="ml-2 text-rose-400 hover:text-rose-600"><i class="fa-solid fa-times"></i></button>
              </div>
            `;
            })
            .join("");
          totalEl.innerText = UTILS.formatCurrency(total);
        }

        updateCartQty(idx, change, type) {
          const item = this.cart[idx];
          const newQty = item.quantity + change;
          if (newQty <= 0) {
            this.removeFromCart(idx, type);
            return;
          }

          // Validation for EXPORT/DAMAGE
          if (["EXPORT", "DAMAGE"].includes(type) && newQty > item.max) {
            UTILS.showToast(`Chỉ còn ${item.max} tồn kho!`, "error");
            return;
          }
          item.quantity = newQty;
          this.renderCart(type);
        }

        removeFromCart(idx, type) {
          this.cart.splice(idx, 1);
          this.renderCart(type);
        }

        submitTransaction(type) {
          if (!this.cart.length)
            return UTILS.showToast("Giỏ hàng trống!", "warning");

          const reason = document.getElementById("txReason").value;
          const partnerEl = document.getElementById("txPartner");
          const locationEl = document.getElementById("txLocation");

          const meta = {
            reason,
            user: this.currentUser.fullname,
            role: this.currentUser.role,
            supplierId:
              ["IMPORT", "RETURN_SUPPLIER"].includes(type) && partnerEl
                ? partnerEl.value
                : null,
            customerId: type === "EXPORT" && partnerEl ? partnerEl.value : null,
            targetLocation:
              type === "TRANSFER" && locationEl ? locationEl.value : null,
          };

          try {
            this.db.addTransaction(type, this.cart, {
              reason,
              user: this.currentUser.fullname,
              role: this.currentUser.role, // <--- Thêm dòng này
            });

            // Thông báo khác nhau tùy role
            if (this.currentUser.role === "STAFF" && type === "DAMAGE") {
              UTILS.showToast(
                "Đã gửi yêu cầu hủy hàng. Chờ quản lý duyệt!",
                "info"
              );
            } else {
              UTILS.showToast("Giao dịch thành công!");
            }

            this.cart = [];
            this.navigate("DASHBOARD");
          } catch (e) {
            UTILS.showToast(e.message, "error");
          }
        }

        renderStocktake(container) {
          const products = this.db.getProducts();
          container.innerHTML = `
            <div class="flex flex-col h-[calc(100vh-140px)] fade-in">
              <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-slate-500">Nhập số lượng thực tế. Hệ thống sẽ tự động tạo phiếu điều chỉnh.</div>
                <button onclick="app.submitStocktake()" class="bg-amber-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-amber-600 shadow transition flex items-center gap-2">
                  <i class="fa-solid fa-check-double"></i> Hoàn Tất & Cân Bằng (US11)
                </button>
              </div>

              <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                <div class="overflow-auto flex-1">
                  <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase sticky top-0 z-10 shadow-sm">
                      <tr><th class="p-4">Sản Phẩm</th><th class="p-4 text-center">Tồn Hệ Thống</th><th class="p-4 text-center w-40">Thực Tế (US10)</th><th class="p-4 text-center">Chênh Lệch</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                      ${products
                        .map(
                          (p) => `
                        <tr>
                          <td class="p-4"><div class="font-bold text-slate-700">${p.name}</div><div class="text-xs text-slate-400 font-mono">${p.sku}</div></td>
                          <td class="p-4 text-center font-bold text-slate-600">${p.currentStock}</td>
                          <td class="p-4"><input type="number" id="stk_${p.id}" value="${p.currentStock}" onchange="app.calcStockDiff('${p.id}', ${p.currentStock})" class="w-full border-2 border-slate-200 rounded px-3 py-1 text-center font-bold text-blue-600 focus:border-brand-500 outline-none"></td>
                          <td class="p-4 text-center font-bold text-slate-400" id="diff_${p.id}">0</td>
                        </tr>
                      `
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          `;
        }

        calcStockDiff(id, systemStock) {
          const val = parseInt(document.getElementById(`stk_${id}`).value) || 0;
          const diff = val - systemStock;
          const el = document.getElementById(`diff_${id}`);
          el.innerText = diff > 0 ? `+${diff}` : diff;
          el.className = `p-4 text-center font-bold ${
            diff === 0
              ? "text-slate-400"
              : diff > 0
              ? "text-emerald-600"
              : "text-rose-600"
          }`;
        }

        handleApprove(txId) {
          if (!confirm("Xác nhận duyệt phiếu hủy này và trừ tồn kho?")) return;
          try {
            this.db.approveTransaction(txId);
            UTILS.showToast("Đã duyệt phiếu thành công!");
            this.renderReport(document.getElementById("viewContainer")); // Load lại bảng
          } catch (e) {
            UTILS.showToast(e.message, "error");
          }
        }

        submitStocktake() {
          if (!confirm("Xác nhận chốt số liệu kiểm kê?")) return;
          const adjustments = [];
          this.db.getProducts().forEach((p) => {
            const actual =
              parseInt(document.getElementById(`stk_${p.id}`).value) || 0;
            if (actual !== p.currentStock)
              adjustments.push({
                productId: p.id,
                quantity: actual,
                price: p.costPrice,
                name: p.name,
              });
          });
          if (!adjustments.length)
            return UTILS.showToast("Số liệu khớp hoàn toàn", "info");
          this.db.addTransaction("STOCKTAKE", adjustments, {
            reason: "Kiểm kê định kỳ (US11)",
            user: this.currentUser.fullname,
          });
          UTILS.showToast("Đã cân bằng kho thành công!");
          this.navigate("DASHBOARD");
        }

        // --- REPORT & HISTORY ---
        renderReport(container) {
          const txs = this.db.transactions;
          container.innerHTML = `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col fade-in">
              <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">Lịch sử giao dịch toàn hệ thống</h3>
                <span class="text-xs text-slate-400">Hiển thị ${
                  txs.length
                } giao dịch</span>
              </div>
              <div class="overflow-auto flex-1">
                 <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase sticky top-0">
                      <tr><th class="p-4">Mã GD</th><th class="p-4">Ngày</th><th class="p-4">Loại</th><th class="p-4">Người tạo</th><th class="p-4">Ghi chú</th><th class="p-4 text-right">Tổng Tiền</th><th class="p-4 text-center">Chi tiết</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-sm">
                      ${txs
                        .map((t) => {
                          // Logic màu sắc trạng thái
                          const statusLabel =
                            t.status === "PENDING"
                              ? '<span class="text-orange-600 bg-orange-100 px-2 py-1 rounded text-xs font-bold">Chờ duyệt</span>'
                              : '<span class="text-green-600 bg-green-100 px-2 py-1 rounded text-xs font-bold">Đã duyệt</span>';

                          // Logic nút bấm (Chỉ hiện nếu Pending và User là Admin)
                          const actionBtn =
                            t.status === "PENDING" &&
                            this.currentUser.role === "ADMIN"
                              ? `<button onclick="app.handleApprove('${t.id}')" class="bg-brand-600 text-white px-2 py-1 rounded text-xs hover:bg-brand-700">Duyệt ngay</button>`
                              : `<button onclick="app.showTransactionDetail('${t.id}')" class="text-brand-600 hover:underline text-xs">Xem</button>`;

                          return `
    <tr class="hover:bg-slate-50">
      <td class="p-4 font-mono text-slate-500 text-xs">${t.id}</td>
      <td class="p-4">
        <div>${UTILS.formatDate(t.date)}</div>
        <div class="mt-1">${statusLabel}</div> </td>
      <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${
        TX_TYPES[t.type].bg
      } ${TX_TYPES[t.type].color}">${TX_TYPES[t.type].label}</span></td>
      <td class="p-4 text-slate-600">${t.createdBy || "System"}</td>
      <td class="p-4 text-slate-500 italic truncate max-w-xs">${
        t.reason || "-"
      }</td>
      <td class="p-4 text-right font-medium">${UTILS.formatCurrency(
        t.totalValue
      )}</td>
      <td class="p-4 text-center">
         ${actionBtn} </td>
    </tr>
  `;
                        })
                        .join("")}
                    </tbody>
                 </table>
              </div>
            </div>
          `;
        }

        showTransactionDetail(txId) {
          const tx = this.db.transactions.find((t) => t.id === txId);
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");

          content.innerHTML = `
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                   <div>
                       <h3 class="font-bold text-lg text-slate-800">Chi tiết giao dịch</h3>
                       <div class="text-xs text-slate-500 font-mono">${txId} • ${UTILS.formatDate(
            tx.date
          )}</div>
                   </div>
                   <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 bg-slate-50 border-b border-slate-100 flex gap-4">
                     <div class="flex-1">
                         <div class="text-xs text-slate-500 uppercase font-bold">Loại phiếu</div>
                         <div class="text-sm font-medium ${
                           TX_TYPES[tx.type].color
                         }">${TX_TYPES[tx.type].label}</div>
                     </div>
                     <div class="flex-1">
                         <div class="text-xs text-slate-500 uppercase font-bold">Người tạo</div>
                         <div class="text-sm font-medium">${
                           tx.createdBy || "System"
                         }</div>
                     </div>
                     <div class="flex-1">
                         <div class="text-xs text-slate-500 uppercase font-bold">Lý do/Ghi chú</div>
                         <div class="text-sm font-medium italic">${
                           tx.reason || "-"
                         }</div>
                     </div>
                </div>
                <div class="flex-1 overflow-auto p-0">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white text-slate-500 font-bold border-b border-slate-100">
                            <tr><th class="p-4">Sản phẩm</th><th class="p-4 text-right">Đơn giá</th><th class="p-4 text-center">Số lượng</th><th class="p-4 text-right">Thành tiền</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${tx.items
                              .map(
                                (i) => `
                                <tr>
                                    <td class="p-4 font-medium text-slate-700">${
                                      i.name
                                    }</td>
                                    <td class="p-4 text-right text-slate-500">${UTILS.formatCurrency(
                                      i.price
                                    )}</td>
                                    <td class="p-4 text-center font-bold">${
                                      i.quantity
                                    }</td>
                                    <td class="p-4 text-right font-medium">${UTILS.formatCurrency(
                                      i.price * i.quantity
                                    )}</td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                        <tfoot class="bg-slate-50 font-bold">
                            <tr>
                                <td colspan="3" class="p-4 text-right text-slate-600">Tổng cộng:</td>
                                <td class="p-4 text-right text-brand-600">${UTILS.formatCurrency(
                                  tx.totalValue
                                )}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
          this._showModal(overlay, content);
        }

        // --- MODALS & HELPERS ---
        openProductModal(id = null) {
          const isEdit = !!id;
          const p = isEdit ? this.db.getProduct(id) : {};
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");

          content.innerHTML = `
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <h3 class="font-bold text-lg text-slate-800">${
                isEdit ? "Sửa Sản Phẩm (US02)" : "Thêm Sản Phẩm Mới (US01)"
              }</h3>
              <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <form id="productForm" class="p-6 grid grid-cols-2 gap-4 overflow-y-auto">
              <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">SKU *</label><input name="sku" value="${
                p.sku || ""
              }" ${
            isEdit
              ? 'disabled class="bg-slate-100 cursor-not-allowed w-full border rounded p-2"'
              : 'class="w-full border rounded p-2"'
          } required></div>
              <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tên Sản Phẩm *</label><input name="name" value="${
                p.name || ""
              }" class="w-full border rounded p-2" required></div>
              <div class="col-span-1">
                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Danh Mục (US03)</label>
                 <select name="category" class="w-full border rounded p-2">
                    ${this.db.settings.categories
                      .map(
                        (c) =>
                          `<option ${
                            p.category === c ? "selected" : ""
                          }>${c}</option>`
                      )
                      .join("")}
                 </select>
              </div>
              <div class="col-span-1">
                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Đơn Vị Tính</label>
                 <select name="unit" class="w-full border rounded p-2">
                    ${this.db.settings.units
                      .map(
                        (u) =>
                          `<option ${
                            p.unit === u ? "selected" : ""
                          }>${u}</option>`
                      )
                      .join("")}
                 </select>
              </div>
              <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Giá Vốn</label><input type="number" name="costPrice" value="${
                p.costPrice || 0
              }" class="w-full border rounded p-2" required></div>
              <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Giá Bán</label><input type="number" name="sellingPrice" value="${
                p.sellingPrice || 0
              }" class="w-full border rounded p-2" required></div>
              <div class="col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL Hình Ảnh</label><input name="image" value="${
                p.image || ""
              }" class="w-full border rounded p-2"></div>
              
              <div class="col-span-2 bg-amber-50 p-4 rounded-lg border border-amber-200 mt-2">
                <div class="flex items-center gap-3">
                   <div class="bg-amber-100 text-amber-600 p-2 rounded"><i class="fa-solid fa-bell"></i></div>
                   <div class="flex-1"><div class="text-sm font-bold text-amber-800">Cảnh báo tồn kho (US09)</div><div class="text-xs text-amber-600">Báo đỏ khi tồn thấp hơn mức này.</div></div>
                   <input type="number" name="minStock" value="${
                     p.minStock || 5
                   }" class="w-20 border border-amber-300 rounded p-2 text-center font-bold text-amber-800 outline-none">
                </div>
              </div>

              <div class="col-span-2 mt-4 flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                <button type="submit" class="px-6 py-2 bg-brand-600 text-white font-bold rounded-lg shadow hover:bg-brand-700">Lưu Dữ Liệu</button>
              </div>
            </form>
          `;

          this._showModal(overlay, content);

          document.getElementById("productForm").onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.costPrice = Number(data.costPrice);
            data.sellingPrice = Number(data.sellingPrice);
            data.minStock = Number(data.minStock);

            try {
              if (isEdit) {
                this.db.updateProduct(id, data);
                UTILS.showToast("Cập nhật thành công!");
              } else {
                this.db.addProduct(data);
                UTILS.showToast("Thêm mới thành công!");
              }
              this.closeModal();
              this.renderProductList(
                document.querySelector("#productTableBody").parentElement
                  .parentElement.parentElement
              );
            } catch (err) {
              UTILS.showToast(err.message, "error");
            }
          };
        }

        showProductHistory(id) {
          const p = this.db.getProduct(id);
          const txs = this.db.transactions.filter((t) =>
            t.items.some((i) => i.productId === id)
          );
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");

          content.innerHTML = `
             <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div><h3 class="font-bold text-lg text-slate-800">Thẻ Kho (US19)</h3><div class="text-sm text-slate-500">${
                  p.name
                } (${p.sku})</div></div>
                <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
             </div>
             <div class="flex-1 overflow-auto p-0">
               <table class="w-full text-left text-sm">
                 <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0">
                   <tr><th class="p-4">Ngày</th><th class="p-4">Loại GD</th><th class="p-4 text-right">SL Đổi</th><th class="p-4 text-right">Tồn Sau GD</th></tr>
                 </thead>
                 <tbody class="divide-y divide-slate-100">
                   ${
                     txs.length === 0
                       ? '<tr><td colspan="4" class="p-6 text-center text-slate-400">Chưa có giao dịch phát sinh</td></tr>'
                       : txs
                           .map((t) => {
                             const item = t.items.find(
                               (i) => i.productId === id
                             );
                             const conf = TX_TYPES[t.type];
                             const change =
                               item.change || item.quantity * conf.sign;
                             return `<tr>
                           <td class="p-4 text-slate-600">${UTILS.formatDate(
                             t.date
                           )}</td>
                           <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${
                             conf.bg
                           } ${conf.color}">${conf.label}</span></td>
                           <td class="p-4 text-right font-bold ${
                             change > 0 ? "text-emerald-600" : "text-rose-600"
                           }">${change > 0 ? "+" : ""}${change}</td>
                           <td class="p-4 text-right font-mono">${
                             item.snapshotStock
                           }</td>
                         </tr>`;
                           })
                           .join("")
                   }
                 </tbody>
               </table>
             </div>
           `;
          this._showModal(overlay, content);
        }

        softDeleteProduct(id) {
          if (confirm("Bạn có chắc chắn muốn ngưng kinh doanh sản phẩm này?")) {
            this.db.deleteProduct(id);
            UTILS.showToast("Đã xóa sản phẩm");
            this.navigate("PRODUCTS");
          }
        }

        exportExcel() {
          const data = this.db
            .getProducts()
            .map((p) => [
              p.sku,
              p.name,
              p.category,
              p.currentStock,
              p.costPrice,
              p.sellingPrice,
            ]);
          const header = [
            "SKU",
            "Ten San Pham",
            "Danh Muc",
            "Ton Kho",
            "Gia Von",
            "Gia Ban",
          ];
          UTILS.exportToCSV(
            `Inventory_Report_${new Date().toISOString().split("T")[0]}.csv`,
            [header, ...data]
          );
          UTILS.showToast("Đã tải xuống file báo cáo");
        }

        resetData() {
          if (confirm("Reset dữ liệu sẽ đăng xuất bạn. Tiếp tục?")) {
            this.db.reset();
            this.logout();
          }
        }

        _showModal(overlay, content) {
          overlay.classList.remove("hidden");
          setTimeout(() => {
            overlay.classList.remove("opacity-0");
            content.classList.remove("opacity-0", "scale-95");
          }, 10);
        }

        closeModal() {
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");
          overlay.classList.add("opacity-0");
          content.classList.add("opacity-0", "scale-95");
          setTimeout(() => overlay.classList.add("hidden"), 200);
        }

        renderPartners(container, type) {
          // type: 'suppliers' or 'customers'
          const title = type === "suppliers" ? "Nhà Cung Cấp" : "Khách Hàng";
          const data = this.db[type];

          container.innerHTML = `
        <div class="flex justify-between items-center mb-6 fade-in">
            <h3 class="font-bold text-slate-700">Quản lý ${title}</h3>
            <button onclick="app.openPartnerModal('${type}')" class="bg-brand-600 text-white px-4 py-2 rounded-lg shadow hover:bg-brand-700"><i class="fa-solid fa-plus mr-2"></i> Thêm mới</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-50 font-bold text-slate-500 border-b">
                    <tr><th class="p-4">Tên</th><th class="p-4">SĐT</th><th class="p-4">Địa chỉ</th><th class="p-4 text-right">${
                      type === "suppliers" ? "Công nợ (Phải trả)" : "Tổng mua"
                    }</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    ${data
                      .map(
                        (p) => `
                        <tr class="hover:bg-slate-50">
                            <td class="p-4 font-bold text-slate-700">${
                              p.name
                            }</td>
                            <td class="p-4 text-slate-500">${p.phone}</td>
                            <td class="p-4 text-slate-500">${p.address}</td>
                            <td class="p-4 text-right font-bold ${
                              type === "suppliers"
                                ? "text-rose-600"
                                : "text-emerald-600"
                            }">
                                ${UTILS.formatCurrency(
                                  type === "suppliers" ? p.debt : p.totalSpent
                                )}
                            </td>
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
    `;
        }

        openPartnerModal(type) {
          const title =
            type === "suppliers" ? "Thêm Nhà Cung Cấp" : "Thêm Khách Hàng";
          const overlay = document.getElementById("modalOverlay");
          const content = document.getElementById("modalContent");

          content.innerHTML = `
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="font-bold text-lg">${title}</h3>
            <button onclick="app.closeModal()"><i class="fa-solid fa-times"></i></button>
        </div>
        <form id="partnerForm" class="p-6 space-y-4">
            <input name="name" placeholder="Tên đơn vị / Khách hàng *" class="w-full border rounded p-2" required>
            <input name="phone" placeholder="Số điện thoại" class="w-full border rounded p-2">
            <input name="address" placeholder="Địa chỉ" class="w-full border rounded p-2">
            <button type="submit" class="w-full bg-brand-600 text-white font-bold py-2 rounded">Lưu thông tin</button>
        </form>
    `;
          this._showModal(overlay, content);

          document.getElementById("partnerForm").onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            this.db.addPartner(type, Object.fromEntries(fd));
            UTILS.showToast("Thêm thành công");
            this.closeModal();
            this.navigate(type === "suppliers" ? "SUPPLIERS" : "CUSTOMERS");
          };
        }
      }

      // --- BOOTSTRAP ---
      const app = new App();

      // Seed Data if new
      if (app.db.getProducts().length === 0) {
        const mocks = [
          {
            sku: "SP001",
            name: "iPhone 15 Pro Max",
            category: "Điện Tử",
            costPrice: 25000000,
            sellingPrice: 30000000,
            unit: "Cái",
            minStock: 5,
          },
          {
            sku: "SP002",
            name: "Nồi Cơm Điện Sharp",
            category: "Gia Dụng",
            costPrice: 500000,
            sellingPrice: 850000,
            unit: "Cái",
            minStock: 10,
          },
          {
            sku: "SP003",
            name: "Sữa Tươi Vinamilk",
            category: "Thực Phẩm",
            costPrice: 280000,
            sellingPrice: 350000,
            unit: "Thùng",
            minStock: 20,
          },
          {
            sku: "SP004",
            name: "Áo Thun Polo",
            category: "Thời Trang",
            costPrice: 150000,
            sellingPrice: 290000,
            unit: "Cái",
            minStock: 10,
          },
        ];
        mocks.forEach((m) => app.db.addProduct(m));
        app.db.addTransaction(
          "IMPORT",
          [
            {
              productId: app.db.products[0].id,
              quantity: 10,
              price: 25000000,
              name: "iPhone 15 Pro Max",
            },
          ],
          { user: "System Init" }
        );
      }
    </script>
  </body>
</html>
