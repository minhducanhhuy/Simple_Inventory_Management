<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hệ Thống Quản Lý Kho & Bán Hàng (IMS PoC)</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Toast Notification Animation */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .toast-enter {
        animation: slideIn 0.3s ease-out forwards;
      }

      /* Table Sticky Header */
      .table-sticky th {
        position: sticky;
        top: 0;
        z-index: 10;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden flex"
  >
    <!-- SIDEBAR -->
    <aside
      class="w-64 bg-slate-900 text-white flex flex-col transition-all duration-300"
      id="sidebar"
    >
      <div
        class="h-16 flex items-center justify-center border-b border-slate-700"
      >
        <h1 class="text-xl font-bold tracking-wider">
          <i class="fa-solid fa-boxes-stacked mr-2"></i>IMS PRO
        </h1>
      </div>

      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-1 px-2" id="navMenu">
          <!-- Menu items will be injected by JS based on Role -->
        </ul>
      </nav>

      <div class="p-4 border-t border-slate-700 text-xs text-slate-400">
        <p>Version 1.0.0 (PoC)</p>
        <p>&copy; 2026 IMS Corp</p>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden">
      <!-- TOP HEADER -->
      <header
        class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-20"
      >
        <!-- Global Search -->
        <div class="flex items-center bg-gray-100 rounded-lg px-3 py-2 w-96">
          <i class="fa-solid fa-search text-gray-400"></i>
          <input
            type="text"
            id="globalSearch"
            placeholder="Tìm sản phẩm, mã phiếu (Ctrl+K)..."
            class="bg-transparent border-none outline-none ml-2 w-full text-sm"
          />
        </div>

        <div class="flex items-center gap-4">
          <!-- Role Switcher -->
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500">Vai trò:</span>
            <select
              id="roleSwitcher"
              class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none"
            >
              <option value="OWNER">Chủ cửa hàng</option>
              <option value="MANAGER">Quản lý</option>
              <option value="SALES">Nhân viên Bán hàng</option>
              <option value="WAREHOUSE">Nhân viên Kho</option>
            </select>
          </div>

          <!-- Mock Data Button -->
          <button
            onclick="app.generateMockData()"
            class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200 transition"
            title="Xóa dữ liệu cũ và tạo mới"
          >
            <i class="fa-solid fa-database mr-1"></i> Reset Data
          </button>

          <!-- User Profile -->
          <div
            class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold cursor-pointer"
          >
            A
          </div>
        </div>
      </header>

      <!-- DYNAMIC CONTENT AREA -->
      <div id="contentArea" class="flex-1 overflow-y-auto p-6 relative">
        <!-- Views will be rendered here -->
      </div>
    </main>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div
      id="toastContainer"
      class="fixed top-5 right-5 z-50 flex flex-col gap-2"
    ></div>

    <!-- MODAL CONTAINER (Hidden by default) -->
    <div
      id="modalBackdrop"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40 transition-opacity"
    >
      <div
        id="modalContent"
        class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0"
      >
        <!-- Modal body injected here -->
      </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      /**
       * ====================================================================================
       * MODULE 1: CONSTANTS & UTILS (Tiện ích & Hằng số)
       * ====================================================================================
       */

      const ROLES = {
        OWNER: "OWNER", // Full quyền, xem báo cáo tài chính
        MANAGER: "MANAGER", // Sửa sản phẩm, xem báo cáo kho
        SALES: "SALES", // Xuất kho, Trả hàng
        WAREHOUSE: "WAREHOUSE", // Nhập kho, Kiểm kê
      };

      const TX_TYPES = {
        IMPORT: "IMPORT", // Nhập hàng (US05)
        EXPORT: "EXPORT", // Xuất bán (US06)
        RETURN: "RETURN", // Khách trả hàng (US15)
        STOCKTAKE: "STOCKTAKE", // Kiểm kê (US10)
        DAMAGE: "DAMAGE", // Hủy/Thanh lý (US17)
        TRANSFER: "TRANSFER", // Chuyển kho (US08)
      };

      const FORMATTER = {
        currency: (amount) =>
          new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(amount),
        date: (dateStr) => new Date(dateStr).toLocaleString("vi-VN"),
        number: (num) => new Intl.NumberFormat("vi-VN").format(num),
      };

      const Utils = {
        generateId: () => Math.random().toString(36).substr(2, 9).toUpperCase(),

        // Hàm hiển thị thông báo (Toast)
        showToast: (message, type = "success") => {
          const container = document.getElementById("toastContainer");
          const toast = document.createElement("div");

          const colors = {
            success: "bg-green-500",
            error: "bg-red-500",
            warning: "bg-yellow-500",
            info: "bg-blue-500",
          };

          toast.className = `${colors[type]} text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[300px] toast-enter`;
          toast.innerHTML = `
                    <i class="fa-solid ${
                      type === "success"
                        ? "fa-check-circle"
                        : "fa-exclamation-circle"
                    }"></i>
                    <span class="font-medium text-sm">${message}</span>
                `;

          container.appendChild(toast);
          setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateX(100%)";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        },
      };

      /**
       * ====================================================================================
       * MODULE 2: STORAGE SERVICE (Quản lý dữ liệu LocalStorage)
       * ====================================================================================
       */
      class StorageService {
        constructor() {
          this.KEYS = {
            PRODUCTS: "ims_products",
            TRANSACTIONS: "ims_transactions",
            SUPPLIERS: "ims_suppliers", // US12
            SETTINGS: "ims_settings",
          };
        }

        get(key) {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        }

        set(key, data) {
          localStorage.setItem(key, JSON.stringify(data));
        }

        // Xóa sạch dữ liệu để reset
        clearAll() {
          localStorage.clear();
        }
      }

      /**
       * ====================================================================================
       * MODULE 3: DATA MANAGERS (Logic nghiệp vụ)
       * ====================================================================================
       */

      // Quản lý sản phẩm (Product Logic)
      class ProductManager {
        constructor(storage) {
          this.storage = storage;
          this.products = this.storage.get(this.storage.KEYS.PRODUCTS);
        }

        getAll() {
          // Lọc sản phẩm chưa bị xóa (Soft delete US04)
          return this.products.filter((p) => !p.isDeleted);
        }

        getById(id) {
          return this.products.find((p) => p.id === id);
        }

        // US01: Thêm sản phẩm
        add(productData) {
          if (this.products.some((p) => p.sku === productData.sku)) {
            throw new Error("Mã SKU đã tồn tại!");
          }
          const newProduct = {
            id: Utils.generateId(),
            ...productData,
            currentStock: 0, // Mặc định tồn kho bằng 0 khi mới tạo
            createdAt: new Date().toISOString(),
            isDeleted: false,
          };
          this.products.push(newProduct);
          this.save();
          return newProduct;
        }

        // US02: Sửa sản phẩm
        update(id, data) {
          const index = this.products.findIndex((p) => p.id === id);
          if (index === -1) throw new Error("Không tìm thấy sản phẩm");

          this.products[index] = { ...this.products[index], ...data };
          this.save();
        }

        // US04: Xóa mềm (Soft Delete)
        remove(id) {
          const product = this.getById(id);
          if (product) {
            product.isDeleted = true;
            this.save();
          }
        }

        // Cập nhật tồn kho (Được gọi từ TransactionManager)
        updateStock(id, quantityChange) {
          const product = this.getById(id);
          if (!product) return;

          product.currentStock += quantityChange;
          this.save();
        }

        save() {
          this.storage.set(this.storage.KEYS.PRODUCTS, this.products);
        }
      }

      // Quản lý giao dịch (Nhập/Xuất/Kiểm kê)
      class TransactionManager {
        constructor(storage, productManager) {
          this.storage = storage;
          this.productManager = productManager;
          this.transactions = this.storage.get(this.storage.KEYS.TRANSACTIONS);
        }

        getAll() {
          return this.transactions.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );
        }

        // Tạo giao dịch mới (Core Logic cho US05, US06, US10, US15, US17)
        createTransaction(type, items, metaData = {}) {
          // Validate trước khi thực hiện
          if (type === TX_TYPES.EXPORT || type === TX_TYPES.DAMAGE) {
            items.forEach((item) => {
              const product = this.productManager.getById(item.productId);
              if (product.currentStock < item.quantity) {
                throw new Error(
                  `Sản phẩm ${product.name} không đủ tồn kho! (Còn: ${product.currentStock})`
                );
              }
            });
          }

          const transaction = {
            id: Utils.generateId(),
            type,
            date: new Date().toISOString(),
            items, // [{ productId, quantity, price }]
            totalValue: items.reduce(
              (sum, item) => sum + item.quantity * item.price,
              0
            ),
            ...metaData, // supplierId, customerInfo, reason, etc.
          };

          // Cập nhật tồn kho dựa trên loại giao dịch
          items.forEach((item) => {
            let change = 0;
            switch (type) {
              case TX_TYPES.IMPORT:
              case TX_TYPES.RETURN: // Khách trả lại -> Tăng kho
                change = item.quantity;
                break;
              case TX_TYPES.EXPORT:
              case TX_TYPES.DAMAGE: // Hư hỏng/Thanh lý -> Giảm kho
                change = -item.quantity;
                break;
              case TX_TYPES.STOCKTAKE:
                // US11: Tự động điều chỉnh kho
                // Với Stocktake, item.quantity là số thực tế. Ta cần tính chênh lệch.
                const current = this.productManager.getById(
                  item.productId
                ).currentStock;
                change = item.quantity - current;
                break;
            }
            this.productManager.updateStock(item.productId, change);
          });

          this.transactions.push(transaction);
          this.save();
          return transaction;
        }

        // US19: Lấy lịch sử giao dịch của 1 sản phẩm (Thẻ kho)
        getProductHistory(productId) {
          return this.transactions
            .filter((tx) =>
              tx.items.some((item) => item.productId === productId)
            )
            .map((tx) => {
              const item = tx.items.find((i) => i.productId === productId);
              return {
                ...tx,
                itemQuantity: item.quantity,
                itemPrice: item.price,
              };
            });
        }

        save() {
          this.storage.set(this.storage.KEYS.TRANSACTIONS, this.transactions);
        }
      }

      /**
       * ====================================================================================
       * MODULE 4: MOCK DATA GENERATOR (Tạo dữ liệu mẫu)
       * ====================================================================================
       */
      class MockDataGenerator {
        constructor(storageService) {
          this.storage = storageService;
        }

        generate() {
          this.storage.clearAll();

          // 1. Tạo Danh mục & Sản phẩm mẫu
          const categories = ["Thực phẩm", "Đồ uống", "Gia dụng", "Điện tử"];
          const products = [];
          for (let i = 1; i <= 30; i++) {
            const cat =
              categories[Math.floor(Math.random() * categories.length)];
            const cost = Math.floor(Math.random() * 50) * 1000 + 10000;
            products.push({
              id: `PROD-${i}`,
              sku: `SKU-${1000 + i}`,
              name: `Sản phẩm Demo ${i} (${cat})`,
              category: cat,
              unit: "Cái",
              costPrice: cost,
              sellingPrice: cost * 1.3,
              minStock: 10,
              currentStock: Math.floor(Math.random() * 100), // Stock ban đầu
              isDeleted: false,
            });
          }
          this.storage.set(this.storage.KEYS.PRODUCTS, products);

          // 2. Tạo Nhà cung cấp mẫu (US12)
          const suppliers = [
            {
              id: "SUP1",
              name: "Công ty ABC",
              phone: "0909123456",
              address: "Hà Nội",
              debt: 0,
            },
            {
              id: "SUP2",
              name: "NPP XYZ",
              phone: "0912345678",
              address: "HCM",
              debt: 5000000,
            },
          ];
          this.storage.set(this.storage.KEYS.SUPPLIERS, suppliers);

          // 3. Tạo lịch sử giao dịch mẫu (Để biểu đồ đẹp)
          const transactions = [];
          const types = [TX_TYPES.IMPORT, TX_TYPES.EXPORT];

          // Giả lập 20 giao dịch gần nhất
          for (let k = 0; k < 20; k++) {
            const type = types[Math.floor(Math.random() * types.length)];
            const items = [
              {
                productId: `PROD-${Math.floor(Math.random() * 20) + 1}`,
                quantity: Math.floor(Math.random() * 10) + 1,
                price: 50000,
              },
            ];
            transactions.push({
              id: `TX-${k}`,
              type: type,
              date: new Date(Date.now() - k * 86400000).toISOString(), // Mỗi ngày 1 cái
              items: items,
              totalValue: items[0].quantity * items[0].price,
              createdBy: "Admin",
            });
          }
          this.storage.set(this.storage.KEYS.TRANSACTIONS, transactions);

          Utils.showToast("Đã tạo dữ liệu mẫu thành công!", "success");
          setTimeout(() => location.reload(), 1000);
        }
      }

      /**
       * ====================================================================================
       * MODULE 5: UI MANAGER (Quản lý giao diện chính)
       * ====================================================================================
       */
      class UIManager {
        constructor() {
          this.storage = new StorageService();
          this.productManager = new ProductManager(this.storage);
          this.transactionManager = new TransactionManager(
            this.storage,
            this.productManager
          );
          this.currentRole = ROLES.OWNER; // Mặc định
          this.currentView = "DASHBOARD";

          this.initEventListeners();
          this.renderSidebar();
          this.renderView();
        }

        initEventListeners() {
          // Role Switcher
          document
            .getElementById("roleSwitcher")
            .addEventListener("change", (e) => {
              this.currentRole = e.target.value;
              this.renderSidebar();
              this.renderView("DASHBOARD"); // Về dashboard khi đổi quyền
              Utils.showToast(
                `Đã chuyển sang vai trò: ${this.currentRole}`,
                "info"
              );
            });

          // Global Search
          document
            .getElementById("globalSearch")
            .addEventListener("input", (e) => {
              // Logic search đơn giản: nếu đang ở trang sản phẩm thì lọc sản phẩm
              if (this.currentView === "PRODUCTS") {
                this.renderProductList(e.target.value);
              }
            });
        }

        // Render Sidebar dựa trên Role (US00 - Implicit)
        renderSidebar() {
          const menu = document.getElementById("navMenu");
          menu.innerHTML = "";

          const menuItems = [
            {
              id: "DASHBOARD",
              icon: "fa-chart-pie",
              label: "Tổng quan",
              roles: [ROLES.OWNER, ROLES.MANAGER],
            },
            {
              id: "PRODUCTS",
              icon: "fa-box",
              label: "Sản phẩm",
              roles: [ROLES.OWNER, ROLES.MANAGER, ROLES.WAREHOUSE, ROLES.SALES],
            },
            {
              id: "IMPORT",
              icon: "fa-dolly",
              label: "Nhập kho",
              roles: [ROLES.OWNER, ROLES.WAREHOUSE, ROLES.MANAGER],
            },
            {
              id: "EXPORT",
              icon: "fa-cart-shopping",
              label: "Bán hàng",
              roles: [ROLES.OWNER, ROLES.SALES, ROLES.MANAGER],
            },
            {
              id: "STOCKTAKE",
              icon: "fa-clipboard-check",
              label: "Kiểm kê",
              roles: [ROLES.OWNER, ROLES.WAREHOUSE, ROLES.MANAGER],
            },
            {
              id: "TRANSACTIONS",
              icon: "fa-history",
              label: "Lịch sử GD",
              roles: [ROLES.OWNER, ROLES.MANAGER],
            },
          ];

          menuItems.forEach((item) => {
            if (item.roles.includes(this.currentRole)) {
              const li = document.createElement("li");
              li.className = `p-3 rounded-lg cursor-pointer flex items-center gap-3 hover:bg-slate-800 transition ${
                this.currentView === item.id ? "bg-blue-600" : ""
              }`;
              li.innerHTML = `<i class="fa-solid ${item.icon} w-5"></i> <span>${item.label}</span>`;
              li.onclick = () => this.renderView(item.id);
              menu.appendChild(li);
            }
          });
        }

        // Router đơn giản để chuyển View
        renderView(viewName = this.currentView) {
          this.currentView = viewName;
          this.renderSidebar(); // Update active state

          const content = document.getElementById("contentArea");
          content.innerHTML = ""; // Clear content

          switch (viewName) {
            case "DASHBOARD":
              this.renderDashboard(content);
              break;
            case "PRODUCTS":
              this.renderProductList(content);
              break;
            case "IMPORT":
              this.renderTransactionForm(content, TX_TYPES.IMPORT);
              break;
            case "EXPORT":
              this.renderTransactionForm(content, TX_TYPES.EXPORT);
              break;
            case "STOCKTAKE":
              this.renderStocktake(content);
              break;
            case "TRANSACTIONS":
              this.renderHistory(content);
              break;
            default:
              content.innerHTML = "<p>Đang phát triển...</p>";
          }
        }

        /**
         * VIEW: DASHBOARD (US18)
         */
        renderDashboard(container) {
          const products = this.productManager.getAll();
          const totalStock = products.reduce(
            (sum, p) => sum + p.currentStock,
            0
          );
          const totalValue = products.reduce(
            (sum, p) => sum + p.currentStock * p.costPrice,
            0
          );
          const lowStockCount = products.filter(
            (p) => p.currentStock <= p.minStock
          ).length; // US09

          container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Tổng quan kinh doanh</h2>
                    
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-lg shadow border-l-4 border-blue-500">
                            <p class="text-gray-500 text-sm">Tổng tồn kho</p>
                            <p class="text-2xl font-bold">${FORMATTER.number(
                              totalStock
                            )} <span class="text-sm font-normal">đv</span></p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow border-l-4 border-green-500">
                            <p class="text-gray-500 text-sm">Tổng giá trị kho</p>
                            <p class="text-2xl font-bold text-green-600">${FORMATTER.currency(
                              totalValue
                            )}</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow border-l-4 border-red-500">
                            <p class="text-gray-500 text-sm">Cảnh báo tồn thấp</p>
                            <p class="text-2xl font-bold text-red-600">${lowStockCount} <span class="text-sm font-normal">sản phẩm</span></p>
                            ${
                              lowStockCount > 0
                                ? '<p class="text-xs text-red-400 mt-1">Cần nhập hàng ngay!</p>'
                                : ""
                            }
                        </div>
                         <div class="bg-white p-5 rounded-lg shadow border-l-4 border-purple-500 cursor-pointer" onclick="app.exportExcel()">
                            <p class="text-gray-500 text-sm">Báo cáo</p>
                            <p class="text-lg font-bold text-purple-600"><i class="fa-solid fa-file-excel mr-2"></i>Xuất Excel</p>
                            <p class="text-xs text-gray-400 mt-1">US20 Feature</p>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="font-bold mb-4">Phân bổ tồn kho theo danh mục</h3>
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="font-bold mb-4">Sản phẩm sắp hết hàng (US09)</h3>
                             <div class="overflow-auto max-h-60">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr><th>Sản phẩm</th><th>Tồn</th><th>Định mức</th></tr>
                                    </thead>
                                    <tbody>
                                        ${products
                                          .filter(
                                            (p) => p.currentStock <= p.minStock
                                          )
                                          .map(
                                            (p) => `
                                            <tr class="border-b hover:bg-red-50">
                                                <td class="py-2">${p.name}</td>
                                                <td class="py-2 font-bold text-red-600">${p.currentStock}</td>
                                                <td class="py-2 text-gray-500">${p.minStock}</td>
                                            </tr>
                                        `
                                          )
                                          .join("")}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

          // Render Chart
          setTimeout(() => {
            const ctx = document
              .getElementById("categoryChart")
              .getContext("2d");
            const categories = {};
            products.forEach((p) => {
              categories[p.category] =
                (categories[p.category] || 0) + p.currentStock;
            });

            new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: Object.keys(categories),
                datasets: [
                  {
                    data: Object.values(categories),
                    backgroundColor: [
                      "#3B82F6",
                      "#10B981",
                      "#F59E0B",
                      "#EF4444",
                      "#8B5CF6",
                    ],
                  },
                ],
              },
            });
          }, 100);
        }

        /**
         * VIEW: PRODUCT LIST (US01, US02, US04)
         */
        renderProductList(containerOrKeyword) {
          let container, products;

          if (typeof containerOrKeyword === "string") {
            // Search mode logic
            container = document.getElementById("productListBody");
            const keyword = containerOrKeyword.toLowerCase();
            products = this.productManager
              .getAll()
              .filter(
                (p) =>
                  p.name.toLowerCase().includes(keyword) ||
                  p.sku.toLowerCase().includes(keyword)
              );
            // Chỉ render lại tbody
            container.innerHTML = this._generateProductRows(products);
            return;
          } else {
            container = containerOrKeyword;
            products = this.productManager.getAll();
          }

          container.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Danh sách sản phẩm</h2>
                        ${
                          [
                            ROLES.OWNER,
                            ROLES.MANAGER,
                            ROLES.WAREHOUSE,
                          ].includes(this.currentRole)
                            ? `<button onclick="app.openProductModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                             <i class="fa-solid fa-plus mr-2"></i>Thêm mới
                           </button>`
                            : ""
                        }
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 uppercase text-xs font-bold text-gray-600">
                                    <tr>
                                        <th class="px-6 py-3">SKU</th>
                                        <th class="px-6 py-3">Tên sản phẩm</th>
                                        <th class="px-6 py-3">Nhóm</th>
                                        <th class="px-6 py-3 text-right">Giá vốn</th>
                                        <th class="px-6 py-3 text-right">Giá bán</th>
                                        <th class="px-6 py-3 text-center">Tồn kho</th>
                                        <th class="px-6 py-3 text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="productListBody" class="divide-y divide-gray-200">
                                    ${this._generateProductRows(products)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
        }

        _generateProductRows(products) {
          if (products.length === 0)
            return `<tr><td colspan="7" class="text-center py-8 text-gray-500">Không có dữ liệu</td></tr>`;

          return products
            .map(
              (p) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium">${p.sku}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${
                              p.name
                            }</div>
                            <div class="text-xs text-gray-500">${p.unit}</div>
                        </td>
                        <td class="px-6 py-4"><span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">${
                          p.category
                        }</span></td>
                        <td class="px-6 py-4 text-right">${FORMATTER.currency(
                          p.costPrice
                        )}</td>
                        <td class="px-6 py-4 text-right">${FORMATTER.currency(
                          p.sellingPrice
                        )}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="${
                              p.currentStock <= p.minStock
                                ? "text-red-600 font-bold"
                                : "text-green-600"
                            }">
                                ${p.currentStock}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="app.showStockCard('${
                                  p.id
                                }')" title="Thẻ kho (US19)" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-list-ol"></i></button>
                                ${
                                  [ROLES.OWNER, ROLES.MANAGER].includes(
                                    this.currentRole
                                  )
                                    ? `<button onclick="app.openProductModal('${p.id}')" title="Sửa (US02)" class="text-yellow-500 hover:text-yellow-700"><i class="fa-solid fa-pen"></i></button>
                                   <button onclick="app.deleteProduct('${p.id}')" title="Xóa (US04)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>`
                                    : ""
                                }
                            </div>
                        </td>
                    </tr>
                `
            )
            .join("");
        }

        /**
         * VIEW: TRANSACTION FORM (US05, US06, US14, US15)
         * Dùng chung cho Nhập/Xuất/Trả hàng
         */
        renderTransactionForm(container, type) {
          const title =
            type === TX_TYPES.IMPORT
              ? "Tạo phiếu Nhập kho"
              : "Tạo phiếu Bán hàng";
          const isExport = type === TX_TYPES.EXPORT;
          const products = this.productManager.getAll();

          container.innerHTML = `
                    <div class="flex gap-6 h-full">
                        <!-- Left: Product Selector -->
                        <div class="w-2/3 flex flex-col">
                            <h2 class="text-2xl font-bold mb-4">${title}</h2>
                            <div class="bg-white p-4 rounded shadow mb-4">
                                <input type="text" id="txSearch" placeholder="Tìm sản phẩm để thêm..." class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="flex-1 bg-white rounded shadow overflow-y-auto p-2 grid grid-cols-3 gap-3 content-start">
                                ${products
                                  .map(
                                    (p) => `
                                    <div onclick="app.addToCart('${
                                      p.id
                                    }')" class="border rounded p-3 cursor-pointer hover:shadow-md hover:border-blue-500 transition bg-white flex flex-col justify-between h-32">
                                        <div>
                                            <p class="font-bold text-sm truncate" title="${
                                              p.name
                                            }">${p.name}</p>
                                            <p class="text-xs text-gray-500">${
                                              p.sku
                                            }</p>
                                        </div>
                                        <div>
                                            <p class="text-blue-600 font-bold">${FORMATTER.currency(
                                              isExport
                                                ? p.sellingPrice
                                                : p.costPrice
                                            )}</p>
                                            <p class="text-xs text-right mt-1">Tồn: ${
                                              p.currentStock
                                            }</p>
                                        </div>
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>

                        <!-- Right: Cart & Checkout -->
                        <div class="w-1/3 bg-white shadow-lg rounded-lg flex flex-col">
                            <div class="p-4 border-b bg-gray-50">
                                <h3 class="font-bold text-lg">Thông tin phiếu</h3>
                                ${
                                  isExport
                                    ? `
                                    <div class="mt-2">
                                        <input id="customerName" type="text" placeholder="Tên khách hàng (US14)" class="w-full border rounded p-2 text-sm mb-2">
                                        <input id="customerPhone" type="text" placeholder="SĐT khách hàng" class="w-full border rounded p-2 text-sm">
                                    </div>
                                `
                                    : `
                                    <div class="mt-2">
                                        <select id="supplierSelect" class="w-full border rounded p-2 text-sm">
                                            <option value="">Chọn Nhà cung cấp (US12)</option>
                                            ${this.storage
                                              .get(this.storage.KEYS.SUPPLIERS)
                                              .map(
                                                (s) =>
                                                  `<option value="${s.id}">${s.name}</option>`
                                              )
                                              .join("")}
                                        </select>
                                    </div>
                                `
                                }
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="cartContainer">
                                <!-- Cart items injected here -->
                                <p class="text-center text-gray-400 mt-10">Chưa có sản phẩm nào</p>
                            </div>

                            <div class="p-4 border-t bg-gray-50">
                                <div class="flex justify-between mb-2 text-lg font-bold">
                                    <span>Tổng tiền:</span>
                                    <span id="cartTotal">0 ₫</span>
                                </div>
                                <button onclick="app.submitTransaction('${type}')" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition">
                                    HOÀN TẤT
                                </button>
                            </div>
                        </div>
                    </div>
                `;

          // Init Cart State
          this.currentCart = [];
        }

        addToCart(productId) {
          const product = this.productManager.getById(productId);
          const existingItem = this.currentCart.find(
            (i) => i.productId === productId
          );

          if (existingItem) {
            existingItem.quantity++;
          } else {
            const price =
              this.currentView === "EXPORT"
                ? product.sellingPrice
                : product.costPrice;
            this.currentCart.push({
              productId,
              quantity: 1,
              price,
              name: product.name,
              maxStock: product.currentStock,
            });
          }
          this.renderCart();
        }

        renderCart() {
          const container = document.getElementById("cartContainer");
          const totalEl = document.getElementById("cartTotal");

          if (this.currentCart.length === 0) {
            container.innerHTML =
              '<p class="text-center text-gray-400 mt-10">Chưa có sản phẩm nào</p>';
            totalEl.innerText = "0 ₫";
            return;
          }

          let total = 0;
          container.innerHTML = this.currentCart
            .map((item, index) => {
              total += item.price * item.quantity;
              return `
                        <div class="flex justify-between items-center border-b pb-2">
                            <div class="flex-1">
                                <p class="font-medium text-sm truncate w-40">${
                                  item.name
                                }</p>
                                <p class="text-xs text-gray-500">${FORMATTER.currency(
                                  item.price
                                )}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="app.updateCartQty(${index}, -1)" class="w-6 h-6 bg-gray-200 rounded hover:bg-gray-300">-</button>
                                <span class="font-bold text-sm w-6 text-center">${
                                  item.quantity
                                }</span>
                                <button onclick="app.updateCartQty(${index}, 1)" class="w-6 h-6 bg-gray-200 rounded hover:bg-gray-300">+</button>
                            </div>
                            <button onclick="app.removeFromCart(${index})" class="ml-2 text-red-500"><i class="fa-solid fa-times"></i></button>
                        </div>
                    `;
            })
            .join("");
          totalEl.innerText = FORMATTER.currency(total);
        }

        updateCartQty(index, change) {
          const item = this.currentCart[index];
          const newQty = item.quantity + change;

          if (newQty <= 0) {
            this.currentCart.splice(index, 1);
          } else {
            // Validate tồn kho nếu là xuất
            if (this.currentView === "EXPORT" && newQty > item.maxStock) {
              Utils.showToast(
                `Chỉ còn ${item.maxStock} sản phẩm trong kho!`,
                "error"
              );
              return;
            }
            item.quantity = newQty;
          }
          this.renderCart();
        }

        removeFromCart(index) {
          this.currentCart.splice(index, 1);
          this.renderCart();
        }

        submitTransaction(type) {
          if (this.currentCart.length === 0) {
            Utils.showToast("Giỏ hàng trống!", "warning");
            return;
          }

          try {
            const metaData = {};
            if (type === TX_TYPES.EXPORT) {
              metaData.customerName =
                document.getElementById("customerName").value;
              metaData.customerPhone =
                document.getElementById("customerPhone").value;
            } else if (type === TX_TYPES.IMPORT) {
              metaData.supplierId =
                document.getElementById("supplierSelect").value;
            }

            metaData.createdBy = this.currentRole;

            this.transactionManager.createTransaction(
              type,
              this.currentCart,
              metaData
            );

            Utils.showToast("Giao dịch thành công!", "success");
            this.currentCart = []; // Clear cart
            this.renderView("DASHBOARD"); // Back to dashboard
          } catch (error) {
            Utils.showToast(error.message, "error");
          }
        }

        /**
         * VIEW: MODALS (US01, US02, US19)
         */
        openProductModal(id = null) {
          const isEdit = !!id;
          const product = isEdit ? this.productManager.getById(id) : {};
          const modal = document.getElementById("modalBackdrop");
          const content = document.getElementById("modalContent");

          modal.classList.remove("hidden");
          modal.classList.add("flex");
          setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
          }, 10);

          content.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-4">${
                          isEdit ? "Sửa sản phẩm" : "Thêm sản phẩm mới"
                        }</h3>
                        <form id="productForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Mã SKU</label>
                                    <input type="text" name="sku" value="${
                                      product.sku || ""
                                    }" ${
            isEdit ? "disabled" : ""
          } class="mt-1 w-full border rounded p-2" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tên sản phẩm</label>
                                    <input type="text" name="name" value="${
                                      product.name || ""
                                    }" class="mt-1 w-full border rounded p-2" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nhóm hàng (US03)</label>
                                    <select name="category" class="mt-1 w-full border rounded p-2">
                                        <option value="Thực phẩm" ${
                                          product.category === "Thực phẩm"
                                            ? "selected"
                                            : ""
                                        }>Thực phẩm</option>
                                        <option value="Đồ uống" ${
                                          product.category === "Đồ uống"
                                            ? "selected"
                                            : ""
                                        }>Đồ uống</option>
                                        <option value="Điện tử" ${
                                          product.category === "Điện tử"
                                            ? "selected"
                                            : ""
                                        }>Điện tử</option>
                                        <option value="Khác" ${
                                          product.category === "Khác"
                                            ? "selected"
                                            : ""
                                        }>Khác</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Đơn vị tính</label>
                                    <input type="text" name="unit" value="${
                                      product.unit || "Cái"
                                    }" class="mt-1 w-full border rounded p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Giá vốn</label>
                                    <input type="number" name="costPrice" value="${
                                      product.costPrice || 0
                                    }" class="mt-1 w-full border rounded p-2" required min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Giá bán</label>
                                    <input type="number" name="sellingPrice" value="${
                                      product.sellingPrice || 0
                                    }" class="mt-1 w-full border rounded p-2" required min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Định mức tồn tối thiểu (US09)</label>
                                    <input type="number" name="minStock" value="${
                                      product.minStock || 5
                                    }" class="mt-1 w-full border rounded p-2">
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 mt-6">
                                <button type="button" onclick="app.closeModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Hủy</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Lưu</button>
                            </div>
                        </form>
                    </div>
                `;

          document.getElementById("productForm").onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Convert numbers
            data.costPrice = Number(data.costPrice);
            data.sellingPrice = Number(data.sellingPrice);
            data.minStock = Number(data.minStock);

            try {
              if (isEdit) {
                this.productManager.update(id, data);
                Utils.showToast("Cập nhật thành công");
              } else {
                this.productManager.add(data);
                Utils.showToast("Thêm mới thành công");
              }
              this.closeModal();
              this.renderView("PRODUCTS");
            } catch (err) {
              Utils.showToast(err.message, "error");
            }
          };
        }

        // US19: Stock Card Modal
        showStockCard(productId) {
          const history = this.transactionManager.getProductHistory(productId);
          const product = this.productManager.getById(productId);

          const modal = document.getElementById("modalBackdrop");
          const content = document.getElementById("modalContent");

          modal.classList.remove("hidden");
          modal.classList.add("flex");
          setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
          }, 10);

          content.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold">Thẻ kho: ${
                                  product.name
                                }</h3>
                                <p class="text-sm text-gray-500">SKU: ${
                                  product.sku
                                } | Tồn hiện tại: <span class="font-bold text-blue-600">${
            product.currentStock
          }</span></p>
                            </div>
                            <button onclick="app.closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
                        </div>
                        
                        <div class="overflow-y-auto max-h-[60vh]">
                            <table class="w-full text-sm text-left table-sticky">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2">Ngày</th>
                                        <th class="px-4 py-2">Loại GD</th>
                                        <th class="px-4 py-2">Mã GD</th>
                                        <th class="px-4 py-2 text-right">SL thay đổi</th>
                                        <th class="px-4 py-2 text-right">Đơn giá</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${
                                      history.length > 0
                                        ? history
                                            .map((h) => {
                                              const isIn = [
                                                TX_TYPES.IMPORT,
                                                TX_TYPES.RETURN,
                                              ].includes(h.type);
                                              const color = isIn
                                                ? "text-green-600"
                                                : "text-red-600";
                                              const sign = isIn ? "+" : "-";
                                              return `
                                            <tr>
                                                <td class="px-4 py-2">${FORMATTER.date(
                                                  h.date
                                                )}</td>
                                                <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs font-bold ${
                                                  isIn
                                                    ? "bg-green-100 text-green-800"
                                                    : "bg-red-100 text-red-800"
                                                }">${h.type}</span></td>
                                                <td class="px-4 py-2 text-gray-500 text-xs">${
                                                  h.id
                                                }</td>
                                                <td class="px-4 py-2 text-right font-bold ${color}">${sign}${
                                                h.itemQuantity
                                              }</td>
                                                <td class="px-4 py-2 text-right text-gray-500">${FORMATTER.currency(
                                                  h.itemPrice
                                                )}</td>
                                            </tr>
                                        `;
                                            })
                                            .join("")
                                        : '<tr><td colspan="5" class="text-center py-4 text-gray-400">Chưa có giao dịch nào</td></tr>'
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
        }

        closeModal() {
          const modal = document.getElementById("modalBackdrop");
          const content = document.getElementById("modalContent");
          content.classList.remove("scale-100", "opacity-100");
          content.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }, 200);
        }

        deleteProduct(id) {
          if (
            confirm("Bạn có chắc chắn muốn xóa sản phẩm này? (Soft Delete)")
          ) {
            this.productManager.remove(id);
            Utils.showToast("Đã xóa sản phẩm");
            this.renderView("PRODUCTS");
          }
        }

        // US20: Export Excel (Mock)
        exportExcel() {
          const data = this.productManager.getAll().map((p) => ({
            SKU: p.sku,
            Ten: p.name,
            TonKho: p.currentStock,
            GiaVon: p.costPrice,
            GiaTriTon: p.currentStock * p.costPrice,
          }));
          console.table(data);
          Utils.showToast("Đã xuất dữ liệu ra Console (F12) để kiểm tra!");
        }

        // Helpers for connecting UI events to Logic
        generateMockData() {
          if (confirm("Hành động này sẽ XÓA SẠCH dữ liệu cũ. Tiếp tục?")) {
            new MockDataGenerator(this.storage).generate();
          }
        }
      }

      // --- INIT APP ---
      const app = new UIManager();

      // Expose app functions to window for onclick events in HTML strings
      window.app = app;
    </script>
  </body>
</html>
